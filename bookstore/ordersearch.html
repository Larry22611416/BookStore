<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¨‚å–®æŸ¥è©¢ - æ›¸å®¢ä¾†ç·šä¸Šæ›¸åº—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "å¾®è»Ÿé›…é»‘", Arial, sans-serif;
            background-color: #f5f5f5;
        }

        /* é ‚éƒ¨å°èˆª */
        .top-nav {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 0;
        }

        .top-nav .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 13px;
        }

        .nav-left a, .nav-right a {
            color: #666;
            text-decoration: none;
            margin: 0 10px;
        }

        .nav-left a:hover, .nav-right a:hover {
            color: #4CAF50;
        }

        .nav-right .user-info {
            color: #4CAF50;
            font-weight: bold;
        }

        /* æœå°‹å€åŸŸ */
        .search-section {
            background-color: #fff;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            margin-right: 30px;
        }

        .logo h1 {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
        }

        .search-box {
            flex: 1;
            display: flex;
            max-width: 500px;
        }

        .category-select {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-right: none;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px 0 0 4px;
            outline: none;
        }

        .search-input {
            flex: 1;
            border: 1px solid #ddd;
            border-left: none;
            border-right: none;
            padding: 8px 12px;
            font-size: 14px;
            outline: none;
        }

        .search-btn {
            background-color: #4CAF50;
            color: white;
            border: 1px solid #4CAF50;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        /* éºµåŒ…å±‘å°èˆª */
        .breadcrumb {
            background-color: #fff;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .breadcrumb .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            font-size: 13px;
            color: #666;
        }

        .breadcrumb a {
            color: #4CAF50;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* ä¸»è¦å…§å®¹å€åŸŸ */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            display: flex;
            gap: 20px;
            padding: 0 20px;
        }

        /* å·¦å´é¸å–® */
        .sidebar {
            width: 250px;
            background-color: #fff;
            border-radius: 4px;
            height: fit-content;
        }

        .sidebar-section {
            border-bottom: 1px solid #f0f0f0;
        }

        .sidebar-title {
            background-color: #f8f8f8;
            padding: 12px 15px;
            font-weight: bold;
            color: #333;
            border-bottom: 1px solid #e0e0e0;
        }

        .sidebar-menu {
            list-style: none;
        }

        .sidebar-menu li {
            border-bottom: 1px solid #f5f5f5;
        }

        .sidebar-menu li:last-child {
            border-bottom: none;
        }

        .sidebar-menu a {
            display: block;
            padding: 10px 15px;
            color: #666;
            text-decoration: none;
            font-size: 13px;
            transition: all 0.3s;
        }

        .sidebar-menu a:hover {
            background-color: #f0f0f0;
            color: #4CAF50;
        }

        .sidebar-menu a.active {
            background-color: #4CAF50;
            color: white;
        }

        /* å³å´å…§å®¹å€åŸŸ */
        .content-area {
            flex: 1;
            background-color: #fff;
            border-radius: 4px;
            padding: 20px;
        }

        .page-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        /* ç‹€æ…‹æç¤º */
        .status-indicator {
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            font-size: 14px;
            display: none;
        }

        .status-loading {
            background-color: #e3f2fd;
            color: #1976d2;
            border: 1px solid #bbdefb;
        }

        .status-error {
            background-color: #ffebee;
            color: #c62828;
            border: 1px solid #ffcdd2;
        }

        .status-success {
            background-color: #e8f5e8;
            color: #2e7d32;
            border: 1px solid #c8e6c9;
        }

        /* è¨‚å–®æŸ¥è©¢ç¯©é¸å€åŸŸ */
        .order-filters {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .filter-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .filter-row:last-child {
            margin-bottom: 0;
        }

        .filter-label {
            font-weight: bold;
            min-width: 60px;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 6px 12px;
            border: 1px solid #ddd;
            background-color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .filter-btn.active {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .filter-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* çµ±è¨ˆä¿¡æ¯ */
        .order-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 18px;
            font-weight: bold;
            color: #4CAF50;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* è¨‚å–®åˆ—è¡¨ */
        .order-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .order-table th {
            background-color: #f8f8f8;
            padding: 12px;
            text-align: center;
            font-weight: bold;
            border: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .order-table td {
            padding: 12px;
            text-align: center;
            border: 1px solid #e0e0e0;
            font-size: 13px;
            vertical-align: middle;
        }

        .order-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        .order-number {
            color: #4CAF50;
            font-weight: bold;
            cursor: pointer;
        }

        .order-number:hover {
            text-decoration: underline;
        }

        .order-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: bold;
            white-space: nowrap;
        }

        .status-completed {
            background-color: #e8f5e8;
            color: #2e7d32;
        }

        .status-processing {
            background-color: #fff3e0;
            color: #f57c00;
        }

        .status-shipped {
            background-color: #e3f2fd;
            color: #1976d2;
        }

        .status-cancelled {
            background-color: #ffebee;
            color: #c62828;
        }

        .order-actions {
            display: flex;
            gap: 5px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background-color: #fff;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .action-btn:hover {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* è¨‚å–®é …ç›®å±•é–‹ */
        .order-items {
            background-color: #f8f9fa;
            border-left: 3px solid #4CAF50;
            margin: 5px 0;
            padding: 8px;
            border-radius: 4px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 3px 0;
            font-size: 12px;
        }

        .item-name {
            flex: 1;
            text-align: left;
            margin-right: 10px;
        }

        .item-price {
            color: #666;
            white-space: nowrap;
        }

        /* ç©ºç‹€æ…‹ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state h3 {
            font-size: 18px;
            margin-bottom: 10px;
        }

        .empty-state p {
            margin-bottom: 20px;
        }

        .shop-now-btn {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }

        .shop-now-btn:hover {
            background-color: #45a049;
        }

        /* è¼‰å…¥æŒ‡ç¤ºå™¨ */
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .search-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .filter-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .order-table {
                font-size: 11px;
            }
            
            .order-table th,
            .order-table td {
                padding: 8px 4px;
            }

            .order-stats {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <div class="top-nav">
        <div class="container">
            <div class="nav-left">
                <a href="index.html">å›é¦–é </a>
                <a href="#" onclick="showNewReleases()">æ–°æ›¸æ¨è–¦</a>
                <a href="#" onclick="showBestsellers()">æš¢éŠ·æ¦œ</a>
                <a href="#" onclick="showEbooks()">é›»å­æ›¸åŸ</a>
            </div>
            <div class="nav-right">
                <span class="user-info" id="userInfo">æ­¡è¿ï¼Œæœƒå“¡</span>
                <a href="#" onclick="logout()">ç™»å‡º</a>
                <a href="shopping.html">è³¼ç‰©è»Š(<span id="cartCount">0</span>)</a>
                <a href="#" onclick="toggleLanguage()">ç¹é«”</a>
            </div>
        </div>
    </div>

    <!-- æœå°‹å€åŸŸ -->
    <div class="search-section">
        <div class="search-container">
            <div class="logo">
                <a href="index.html" style="text-decoration: none;">
                    <h1>æ›¸å®¢ä¾†</h1>
                </a>
            </div>
            <div class="search-box">
                <select class="category-select">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="chinese">ä¸­æ–‡æ›¸</option>
                    <option value="english">å¤–æ–‡æ›¸</option>
                    <option value="ebook">é›»å­æ›¸</option>
                </select>
                <input type="text" class="search-input" placeholder="æ¯æ—¥å£è¢‹99">
                <button class="search-btn">ğŸ”</button>
            </div>
        </div>
    </div>

    <!-- éºµåŒ…å±‘å°èˆª -->
    <div class="breadcrumb">
        <div class="container">
            <a href="index.html">æ›¸å®¢ä¾†</a> > 
            <a href="#" onclick="showMemberCenter()">æœƒå“¡å°ˆå€</a> > 
            <span>è¨‚å–®æŸ¥è©¢</span>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-container">
        <!-- å·¦å´é¸å–® -->
        <div class="sidebar">
            <!-- äº¤æ˜“ç´€éŒ„ -->
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ“¦ äº¤æ˜“ç´€éŒ„</div>
                <ul class="sidebar-menu">
                    <li><a href="#" class="active" onclick="showOrderSearch()">è¨‚å–®æŸ¥è©¢</a></li>
                    <li><a href="#" onclick="showReturnExchange()">é€€æ›è²¨èˆ‡é–‹ç«‹æ”¶æ“š</a></li>
                    <li><a href="#" onclick="showInvoiceManagement()">ç™¼ç¥¨/ æŠ˜åƒ¹åˆ¸æŸ¥è©¢</a></li>
                    <li><a href="#" onclick="showInternationalOrders()">ä¸‹æ¬¡é è³¼æ¸…å–®</a></li>
                    <li><a href="#" onclick="showSubscriptions()">é—œæ‡·é–±è®€è¨‚é–±</a></li>
                </ul>
            </div>

            <!-- ç”¢å“å“é …ç®¡ç† -->
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ“š ç”¢å“å“é …ç®¡ç†</div>
                <ul class="sidebar-menu">
                    <li><a href="#" onclick="showEbookLibrary()">é›»å­æ›¸åº«</a></li>
                    <li><a href="#" onclick="showAudiobookLibrary()">æœ‰è²æ›¸åº«</a></li>
                    <li><a href="#" onclick="showDigitalContent()">æ•¸ä½å•†å“åº«æŸ¥è©¢ç®¡ç†</a></li>
                    <li><a href="#" onclick="showDownloadHistory()">ä¸‹è¼‰ä½¿ç”¨ç´€éŒ„</a></li>
                </ul>
            </div>

            <!-- æœƒå“¡è³‡æ–™/å¸³æˆ¶ç®¡ç† -->
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ‘¤ æœƒå“¡è³‡æ–™/å¸³æˆ¶ç®¡ç†</div>
                <ul class="sidebar-menu">
                    <li><a href="#" onclick="showPersonalInfo()">å€‹äººè³‡æ–™ç®¡ç†/åœ°å€è¨­å®š</a></li>
                    <li><a href="#" onclick="showAccountSettings()">æœƒå“¡åˆ†ç´šè³‡è¨Š</a></li>
                    <li><a href="#" onclick="showPasswordSettings()">å¸³è™Ÿè³‡å®‰å…¨è¨­å®š</a></li>
                    <li><a href="#" onclick="showSocialAccounts()">OPENPOINT å¸³è™Ÿé€£çµç®¡ç†</a></li>
                    <li><a href="#" onclick="showPreferences()">æœƒå“¡åå¥½è¨­å®š</a></li>
                </ul>
            </div>

            <!-- é›»å­æ›¸ -->
            <div class="sidebar-section">
                <div class="sidebar-title">ğŸ“± é›»å­æ›¸</div>
                <ul class="sidebar-menu">
                    <li><a href="#" onclick="showAllEbooks()">å…¨éƒ¨æ›¸åº«</a></li>
                    <li><a href="#" onclick="showMyEbooks()">æˆ‘çš„æ›¸åº«</a></li>
                    <li><a href="#" onclick="showEbookSubscriptions()">è¨‚é–±æ›¸åº«</a></li>
                </ul>
            </div>
        </div>

        <!-- å³å´å…§å®¹å€åŸŸ -->
        <div class="content-area">
            <h2 class="page-title">è¨‚å–®æŸ¥è©¢</h2>
            
            <!-- ç‹€æ…‹æŒ‡ç¤ºå™¨ -->
            <div class="status-indicator" id="statusIndicator"></div>
            
            <!-- çµ±è¨ˆä¿¡æ¯ -->
            <div class="order-stats" id="orderStats" style="display: none;">
                <div class="stat-item">
                    <div class="stat-number" id="totalOrders">0</div>
                    <div class="stat-label">ç¸½è¨‚å–®æ•¸</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalAmount">$0</div>
                    <div class="stat-label">ç¸½é‡‘é¡</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="completedOrders">0</div>
                    <div class="stat-label">å·²å®Œæˆ</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="processingOrders">0</div>
                    <div class="stat-label">è™•ç†ä¸­</div>
                </div>
            </div>
            
            <!-- ç¯©é¸å™¨ -->
            <div class="order-filters">
                <div class="filter-row">
                    <span class="filter-label">ç‹€æ…‹</span>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterOrders('all')">å…¨éƒ¨</button>
                        <button class="filter-btn" onclick="filterOrders('processing')">è™•ç†ä¸­</button>
                        <button class="filter-btn" onclick="filterOrders('shipped')">å·²å‡ºè²¨</button>
                        <button class="filter-btn" onclick="filterOrders('completed')">å·²å®Œæˆ</button>
                    </div>
                </div>
                <div class="filter-row">
                    <span class="filter-label">æ™‚é–“</span>
                    <div class="filter-buttons">
                        <button class="filter-btn" onclick="filterByTime('week')">æœ€è¿‘ä¸€é€±</button>
                        <button class="filter-btn" onclick="filterByTime('month')">æœ€è¿‘ä¸€æœˆ</button>
                        <button class="filter-btn" onclick="filterByTime('quarter')">æœ€è¿‘ä¸‰æœˆ</button>
                        <button class="filter-btn" onclick="filterByTime('year')">æœ€è¿‘ä¸€å¹´</button>
                    </div>
                </div>
            </div>

            <!-- èªªæ˜æ–‡å­— -->
            <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
                é¡¯ç¤ºæ‚¨çš„æ‰€æœ‰è¨‚å–®è¨˜éŒ„ã€‚å¦‚éœ€æŸ¥è©¢æ›´ä¹…å‰çš„è¨‚å–®è³‡æ–™ï¼Œè«‹è¯ç¹«å®¢æœã€‚é›»å­æ›¸è¨‚å–®è«‹åˆ°<a href="#" style="color: #4CAF50;" onclick="showEbookLibrary()">é›»å­æ›¸åº«</a>æŸ¥è©¢ã€‚
            </p>

            <!-- è¨‚å–®è¡¨æ ¼ -->
            <div id="orderTableContainer">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>è¨‚å–®ç·¨è™Ÿ</th>
                            <th>è¨‚è³¼æ™‚é–“</th>
                            <th>ä»˜æ¬¾æ–¹å¼</th>
                            <th>è¨‚å–®é‡‘é¡</th>
                            <th>å•†å“è³‡è¨Š</th>
                            <th>è™•ç†ç‹€æ…‹</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="orderTableBody">
                        <!-- è¨‚å–®æ•¸æ“šå°‡é€šé JavaScript è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>

            <!-- ç©ºç‹€æ…‹ -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <h3>ğŸ” ç›®å‰æ²’æœ‰ç¬¦åˆæ¢ä»¶çš„è¨‚å–®</h3>
                <p>æ‚¨å¯ä»¥èª¿æ•´ç¯©é¸æ¢ä»¶æˆ–å›åˆ°è³¼ç‰©é é¢ç¹¼çºŒé¸è³¼</p>
                <a href="index.html" class="shop-now-btn">å‰å¾€è³¼ç‰©</a>
            </div>
        </div>
    </div>

    <!-- è³‡æ–™åº«ç®¡ç†ç³»çµ± -->
    <script src="js/database.js"></script>
    <script>
        // è¨‚å–®ç®¡ç†ç³»çµ±
        class OrderManager {
            constructor() {
                this.currentUser = null;
                this.allOrders = [];
                this.filteredOrders = [];
                this.currentFilter = 'all';
                this.currentTimeFilter = null;
                this.isDbReady = false;
                this.init();
            }

            async init() {
                console.log('ğŸš€ åˆå§‹åŒ–è¨‚å–®ç®¡ç†ç³»çµ±...');
                
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                const loginCheck = this.checkLoginStatus();
                if (!loginCheck) return;

                // ç­‰å¾…è³‡æ–™åº«æº–å‚™å°±ç·’
                await this.waitForDatabase();
                
                // è¼‰å…¥ç”¨æˆ¶è¨‚å–®
                await this.loadUserOrders();
                
                console.log('âœ… è¨‚å–®ç®¡ç†ç³»çµ±åˆå§‹åŒ–å®Œæˆ');
            }

            checkLoginStatus() {
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                const userEmail = localStorage.getItem('userEmail');
                
                if (!isLoggedIn || isLoggedIn !== 'true' || !userEmail) {
                    this.showError('è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½æŸ¥è©¢è¨‚å–®');
                    setTimeout(() => {
                        window.location.href = 'login.html?redirect=ordersearch.html';
                    }, 2000);
                    return false;
                }
                
                this.currentUser = userEmail;
                document.getElementById('userInfo').textContent = `æ­¡è¿ï¼Œ${userEmail}`;
                return true;
            }

            async waitForDatabase() {
                this.showLoading('æ­£åœ¨é€£æ¥è³‡æ–™åº«...');
                
                return new Promise((resolve) => {
                    const checkDatabase = () => {
                        if (window.bookstoreDB && window.bookstoreDB.isReady) {
                            this.isDbReady = true;
                            console.log('âœ… è³‡æ–™åº«å·²å°±ç·’');
                            resolve();
                        } else {
                            setTimeout(checkDatabase, 100);
                        }
                    };
                    
                    checkDatabase();
                    
                    // ç›£è½è³‡æ–™åº«äº‹ä»¶
                    window.addEventListener('databaseReady', () => {
                        this.isDbReady = true;
                        resolve();
                    });
                    
                    window.addEventListener('databaseError', (e) => {
                        this.showError('è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹é‡æ–°æ•´ç†é é¢');
                        console.error('âŒ è³‡æ–™åº«éŒ¯èª¤:', e.detail);
                    });
                });
            }

            async loadUserOrders() {
                try {
                    this.showLoading('æ­£åœ¨è¼‰å…¥è¨‚å–®è³‡æ–™...');
                    
                    if (!this.isDbReady) {
                        throw new Error('è³‡æ–™åº«æœªæº–å‚™å°±ç·’');
                    }

                    // å¾è³‡æ–™åº«ç²å–ç”¨æˆ¶è¨‚å–®
                    this.allOrders = await window.bookstoreDB.getUserOrders(this.currentUser);
                    console.log(`âœ… è¼‰å…¥äº† ${this.allOrders.length} ç­†è¨‚å–®`);
                    
                    this.filteredOrders = [...this.allOrders];
                    this.updateOrderDisplay();
                    this.updateStatistics();
                    this.hideStatus();
                    
                } catch (error) {
                    console.error('âŒ è¼‰å…¥è¨‚å–®å¤±æ•—:', error);
                    this.showError('è¼‰å…¥è¨‚å–®è³‡æ–™å¤±æ•—: ' + error.message);
                }
            }

            updateOrderDisplay() {
                const tableBody = document.getElementById('orderTableBody');
                const tableContainer = document.getElementById('orderTableContainer');
                const emptyState = document.getElementById('emptyState');
                
                if (this.filteredOrders.length === 0) {
                    tableContainer.style.display = 'none';
                    emptyState.style.display = 'block';
                    return;
                }
                
                tableContainer.style.display = 'block';
                emptyState.style.display = 'none';
                
                tableBody.innerHTML = this.filteredOrders.map(order => this.renderOrderRow(order)).join('');
            }

            renderOrderRow(order) {
                const paymentMethodMap = {
                    'credit_card': 'ä¿¡ç”¨å¡',
                    'atm': 'ATMè½‰å¸³',
                    'convenience_store': 'è¶…å•†å–è²¨ä»˜æ¬¾',
                    'line_pay': 'LINE Pay',
                    'cash_on_delivery': 'è²¨åˆ°ä»˜æ¬¾'
                };

                const statusMap = {
                    'processing': { class: 'status-processing', text: 'è™•ç†ä¸­' },
                    'shipped': { class: 'status-shipped', text: 'å·²å‡ºè²¨' },
                    'completed': { class: 'status-completed', text: 'å·²å®Œæˆ' },
                    'cancelled': { class: 'status-cancelled', text: 'å·²å–æ¶ˆ' }
                };

                const statusInfo = statusMap[order.status] || { class: 'status-processing', text: 'è™•ç†ä¸­' };
                const paymentMethod = paymentMethodMap[order.paymentMethod] || order.paymentMethod;

                // è™•ç†å•†å“ä¿¡æ¯
                const itemsDisplay = this.renderOrderItems(order.items);

                return `
                    <tr>
                        <td class="order-number" onclick="viewOrderDetail('${order.orderNumber}')">${order.orderNumber}</td>
                        <td>${new Date(order.orderDate).toLocaleString('zh-TW')}</td>
                        <td>${paymentMethod}</td>
                        <td>NT$ ${order.totalAmount.toLocaleString()}</td>
                        <td style="text-align: left; max-width: 300px;">
                            ${itemsDisplay}
                        </td>
                        <td><span class="order-status ${statusInfo.class}">${statusInfo.text}</span></td>
                        <td>
                            <div class="order-actions">
                                <button class="action-btn" onclick="orderManager.viewOrderDetail('${order.orderNumber}')">è©³æƒ…</button>
                                <button class="action-btn" onclick="orderManager.downloadInvoice('${order.orderNumber}')">ç™¼ç¥¨</button>
                                ${order.status === 'processing' ? `<button class="action-btn" onclick="orderManager.cancelOrder('${order.orderNumber}')">å–æ¶ˆ</button>` : ''}
                            </div>
                        </td>
                    </tr>
                `;
            }

            renderOrderItems(items) {
                if (!items || items.length === 0) {
                    return '<div class="order-items">ç„¡å•†å“è³‡è¨Š</div>';
                }

                if (items.length === 1) {
                    const item = items[0];
                    return `
                        <div class="order-items">
                            <div class="order-item">
                                <span class="item-name">${item.title || item.name || 'å•†å“'}</span>
                                <span class="item-price">x${item.quantity} NT$${(item.price * item.quantity).toLocaleString()}</span>
                            </div>
                        </div>
                    `;
                } else {
                    return `
                        <div class="order-items">
                            <div class="order-item">
                                <span class="item-name">${items[0].title || items[0].name || 'å•†å“'} ç­‰ ${items.length} é …å•†å“</span>
                                <span class="item-price">ç¸½è¨ˆ ${items.reduce((sum, item) => sum + item.quantity, 0)} ä»¶</span>
                            </div>
                        </div>
                    `;
                }
            }

            updateStatistics() {
                const stats = document.getElementById('orderStats');
                
                if (this.allOrders.length === 0) {
                    stats.style.display = 'none';
                    return;
                }

                stats.style.display = 'flex';
                
                const totalAmount = this.allOrders.reduce((sum, order) => sum + order.totalAmount, 0);
                const completedOrders = this.allOrders.filter(order => order.status === 'completed').length;
                const processingOrders = this.allOrders.filter(order => order.status === 'processing').length;
                
                document.getElementById('totalOrders').textContent = this.allOrders.length;
                document.getElementById('totalAmount').textContent = `$${totalAmount.toLocaleString()}`;
                document.getElementById('completedOrders').textContent = completedOrders;
                document.getElementById('processingOrders').textContent = processingOrders;
            }

            // ç¯©é¸åŠŸèƒ½
            filterOrders(status) {
                this.currentFilter = status;
                this.applyFilters();
                this.updateFilterButtons();
            }

            filterByTime(period) {
                this.currentTimeFilter = period;
                this.applyFilters();
                this.updateTimeFilterButtons();
            }

            applyFilters() {
                let filtered = [...this.allOrders];

                // ç‹€æ…‹ç¯©é¸
                if (this.currentFilter !== 'all') {
                    filtered = filtered.filter(order => order.status === this.currentFilter);
                }

                // æ™‚é–“ç¯©é¸
                if (this.currentTimeFilter) {
                    const now = new Date();
                    const timeLimit = this.getTimeLimit(this.currentTimeFilter);
                    filtered = filtered.filter(order => new Date(order.orderDate) >= timeLimit);
                }

                this.filteredOrders = filtered;
                this.updateOrderDisplay();
            }

            getTimeLimit(period) {
                const now = new Date();
                switch (period) {
                    case 'week':
                        return new Date(now.setDate(now.getDate() - 7));
                    case 'month':
                        return new Date(now.setMonth(now.getMonth() - 1));
                    case 'quarter':
                        return new Date(now.setMonth(now.getMonth() - 3));
                    case 'year':
                        return new Date(now.setFullYear(now.getFullYear() - 1));
                    default:
                        return new Date(0);
                }
            }

            updateFilterButtons() {
                document.querySelectorAll('.filter-row:first-child .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }

            updateTimeFilterButtons() {
                document.querySelectorAll('.filter-row:last-child .filter-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');
            }

            // è¨‚å–®æ“ä½œ
            viewOrderDetail(orderNumber) {
                const order = this.allOrders.find(o => o.orderNumber === orderNumber);
                if (!order) {
                    alert('æ‰¾ä¸åˆ°è¨‚å–®è³‡è¨Š');
                    return;
                }

                // ç”Ÿæˆè¨‚å–®è©³æƒ…å…§å®¹
                const itemsList = order.items.map(item => 
                    `â€¢ ${item.title || item.name || 'å•†å“'} x${item.quantity} - NT$${(item.price * item.quantity).toLocaleString()}`
                ).join('\n');

                const orderDetail = `
è¨‚å–®ç·¨è™Ÿ: ${order.orderNumber}
è¨‚è³¼æ™‚é–“: ${new Date(order.orderDate).toLocaleString('zh-TW')}
ä»˜æ¬¾æ–¹å¼: ${order.paymentMethod}
è¨‚å–®é‡‘é¡: NT$${order.totalAmount.toLocaleString()}
è™•ç†ç‹€æ…‹: ${order.statusText}
é…é€åœ°å€: ${order.shippingAddress || 'æœªæä¾›'}
å‚™è¨»: ${order.notes || 'ç„¡'}

å•†å“æ¸…å–®:
${itemsList}
                `;

                alert(orderDetail);
                // TODO: å°‡ä¾†æœƒè·³è½‰åˆ°è©³ç´°çš„è¨‚å–®è©³æƒ…é é¢
            }

            downloadInvoice(orderNumber) {
                // TODO: å¯¦ä½œç™¼ç¥¨ä¸‹è¼‰åŠŸèƒ½
                alert(`ç™¼ç¥¨ä¸‹è¼‰åŠŸèƒ½é–‹ç™¼ä¸­...\nè¨‚å–®ç·¨è™Ÿ: ${orderNumber}`);
            }

            async cancelOrder(orderNumber) {
                if (!confirm('ç¢ºå®šè¦å–æ¶ˆæ­¤è¨‚å–®å—ï¼Ÿå–æ¶ˆå¾Œç„¡æ³•å¾©åŸã€‚')) {
                    return;
                }

                try {
                    this.showLoading('æ­£åœ¨å–æ¶ˆè¨‚å–®...');
                    
                    await window.bookstoreDB.updateOrderStatus(orderNumber, 'cancelled', 'å·²å–æ¶ˆ');
                    
                    this.showSuccess('è¨‚å–®å·²æˆåŠŸå–æ¶ˆ');
                    
                    // é‡æ–°è¼‰å…¥è¨‚å–®è³‡æ–™
                    await this.loadUserOrders();
                    
                } catch (error) {
                    console.error('âŒ å–æ¶ˆè¨‚å–®å¤±æ•—:', error);
                    this.showError('å–æ¶ˆè¨‚å–®å¤±æ•—: ' + error.message);
                }
            }

            // ç‹€æ…‹é¡¯ç¤ºæ–¹æ³•
            showLoading(message) {
                const indicator = document.getElementById('statusIndicator');
                indicator.className = 'status-indicator status-loading';
                indicator.innerHTML = `<div class="loading-spinner"></div> ${message}`;
                indicator.style.display = 'block';
            }

            showError(message) {
                const indicator = document.getElementById('statusIndicator');
                indicator.className = 'status-indicator status-error';
                indicator.innerHTML = `âŒ ${message}`;
                indicator.style.display = 'block';
            }

            showSuccess(message) {
                const indicator = document.getElementById('statusIndicator');
                indicator.className = 'status-indicator status-success';
                indicator.innerHTML = `âœ… ${message}`;
                indicator.style.display = 'block';
                
                setTimeout(() => {
                    this.hideStatus();
                }, 3000);
            }

            hideStatus() {
                const indicator = document.getElementById('statusIndicator');
                indicator.style.display = 'none';
            }
        }

        // å…¨åŸŸè®Šæ•¸
        let orderManager;

        // å…¨åŸŸå‡½æ•¸
        function filterOrders(status) {
            if (orderManager) {
                orderManager.filterOrders(status);
            }
        }

        function filterByTime(period) {
            if (orderManager) {
                orderManager.filterByTime(period);
            }
        }

        // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡é¡¯ç¤º
        function updateCartDisplay() {
            const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            const cartCount = cartItems.reduce((total, item) => total + item.quantity, 0);
            const cartCountElement = document.getElementById('cartCount');
            if (cartCountElement) {
                cartCountElement.textContent = cartCount;
            }
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('loginTime');
                alert('å·²æˆåŠŸç™»å‡º');
                window.location.href = 'index.html';
            }
        }

        // å´é‚Šæ¬„å°èˆªåŠŸèƒ½
        function showOrderSearch() {
            updateActiveMenu(event.target);
        }

        function showReturnExchange() {
            alert('é€€æ›è²¨åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showInvoiceManagement() {
            alert('ç™¼ç¥¨æŸ¥è©¢åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showInternationalOrders() {
            alert('é è³¼æ¸…å–®åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showSubscriptions() {
            alert('è¨‚é–±åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showEbookLibrary() {
            alert('é›»å­æ›¸åº«åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showAudiobookLibrary() {
            alert('æœ‰è²æ›¸åº«åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showDigitalContent() {
            alert('æ•¸ä½å•†å“åº«åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showDownloadHistory() {
            alert('ä¸‹è¼‰ç´€éŒ„åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showPersonalInfo() {
            alert('å€‹äººè³‡æ–™ç®¡ç†åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showAccountSettings() {
            alert('å¸³æˆ¶è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showPasswordSettings() {
            alert('å¯†ç¢¼è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showSocialAccounts() {
            alert('ç¤¾ç¾¤å¸³è™Ÿé€£çµåŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showPreferences() {
            alert('åå¥½è¨­å®šåŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showAllEbooks() {
            alert('å…¨éƒ¨é›»å­æ›¸åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showMyEbooks() {
            alert('æˆ‘çš„æ›¸åº«åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showEbookSubscriptions() {
            alert('é›»å­æ›¸è¨‚é–±åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        // æ›´æ–°é¸å–®æ¿€æ´»ç‹€æ…‹
        function updateActiveMenu(target) {
            document.querySelectorAll('.sidebar-menu a').forEach(link => {
                link.classList.remove('active');
            });
            target.classList.add('active');
        }

        // å…¶ä»–å°èˆªåŠŸèƒ½
        function showNewReleases() {
            alert('æ–°æ›¸æ¨è–¦é é¢é–‹ç™¼ä¸­...');
        }

        function showBestsellers() {
            alert('æš¢éŠ·æ¦œé é¢é–‹ç™¼ä¸­...');
        }

        function showEbooks() {
            alert('é›»å­æ›¸åŸé é¢é–‹ç™¼ä¸­...');
        }

        function showMemberCenter() {
            alert('æœƒå“¡ä¸­å¿ƒé¦–é é–‹ç™¼ä¸­...');
        }

        function toggleLanguage() {
            alert('èªè¨€åˆ‡æ›åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        // é é¢è¼‰å…¥æ™‚çš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ è¨‚å–®æŸ¥è©¢é é¢é–‹å§‹è¼‰å…¥...');
            
            updateCartDisplay();
            
            // åˆå§‹åŒ–è¨‚å–®ç®¡ç†ç³»çµ±
            setTimeout(() => {
                orderManager = new OrderManager();
            }, 100);
        });
    </script>
</body>
</html>