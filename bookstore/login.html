<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>會員登入 - 書客來線上書店</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "微軟雅黑", Arial, sans-serif;
            background-color: #f5f5f5;
        }

        /* 頂部導航 */
        .top-nav {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 0;
        }

        .top-nav .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 13px;
        }

        .nav-left a, .nav-right a {
            color: #666;
            text-decoration: none;
            margin: 0 10px;
        }

        .nav-left a:hover, .nav-right a:hover {
            color: #4CAF50;
        }

        /* 搜尋區域 */
        .search-section {
            background-color: #fff;
            padding: 20px 0;
            border-bottom: 2px solid #4CAF50;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            margin-right: 30px;
        }

        .logo h1 {
            color: #4CAF50;
            font-size: 28px;
            font-weight: bold;
            text-decoration: none;
        }

        .search-box {
            flex: 1;
            display: flex;
            max-width: 600px;
        }

        .category-select {
            background-color: #f8f8f8;
            border: 2px solid #4CAF50;
            border-right: none;
            padding: 12px 15px;
            font-size: 14px;
            border-radius: 25px 0 0 25px;
            outline: none;
        }

        .search-input {
            flex: 1;
            border: 2px solid #4CAF50;
            border-left: none;
            border-right: none;
            padding: 12px 15px;
            font-size: 14px;
            outline: none;
        }

        .search-btn {
            background-color: #4CAF50;
            color: white;
            border: 2px solid #4CAF50;
            padding: 12px 20px;
            font-size: 14px;
            border-radius: 0 25px 25px 0;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .search-btn:hover {
            background-color: #45a049;
        }

        /* 主要內容區域 */
        .main-container {
            max-width: 1200px;
            margin: 30px auto;
            display: flex;
            gap: 30px;
            padding: 0 20px;
        }

        /* 左側促銷橫幅 */
        .promo-banner {
            flex: 1;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 8px;
            padding: 40px;
            color: white;
            text-align: center;
            height: fit-content;
        }

        .promo-content h2 {
            font-size: 24px;
            margin-bottom: 15px;
        }

        .promo-content .highlight {
            background-color: #ff6b35;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 18px;
            font-weight: bold;
            margin: 10px 0;
            display: inline-block;
        }

        .promo-content p {
            font-size: 16px;
            margin-bottom: 10px;
        }

        /* 右側登入表單 */
        .login-container {
            background-color: #fff;
            border-radius: 8px;
            padding: 30px;
            width: 400px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .login-title {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 30px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .form-input:focus {
            border-color: #4CAF50;
        }

        .form-input.error {
            border-color: #e74c3c;
        }

        .password-container {
            position: relative;
        }

        .password-toggle {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #666;
            font-size: 16px;
        }

        .login-btn {
            width: 100%;
            background-color: #4CAF50;
            color: white;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            margin-bottom: 15px;
            transition: background-color 0.3s;
        }

        .login-btn:hover {
            background-color: #45a049;
        }

        .login-btn:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .qr-login {
            text-align: center;
            margin-bottom: 20px;
        }

        .qr-btn {
            background-color: #f8f8f8;
            border: 2px solid #e0e0e0;
            padding: 10px 20px;
            border-radius: 8px;
            color: #666;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
        }

        .qr-btn:hover {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        .login-links {
            text-align: center;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .login-links a {
            color: #4CAF50;
            text-decoration: none;
            margin: 0 10px;
            cursor: pointer;
        }

        .login-links a:hover {
            text-decoration: underline;
        }

        .social-login {
            margin-top: 20px;
        }

        .social-title {
            font-size: 14px;
            color: #666;
            margin-bottom: 15px;
        }

        .social-btn {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: opacity 0.3s;
        }

        .social-btn:hover {
            opacity: 0.8;
        }

        .openpoint-btn {
            background-color: #e74c3c;
            color: white;
        }

        .facebook-btn {
            background-color: #3b5998;
            color: white;
        }

        .line-btn {
            background-color: #00c300;
            color: white;
        }

        /* 錯誤訊息 */
        .error-message {
            background-color: #ffebee;
            color: #c62828;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        /* 成功訊息 */
        .success-message {
            background-color: #e8f5e8;
            color: #2e7d32;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 14px;
            display: none;
        }

        /* 測試帳號提示 */
        .test-accounts {
            background-color: #fff3e0;
            border: 1px solid #ffb74d;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 13px;
        }

        .test-accounts h4 {
            color: #e65100;
            margin-bottom: 10px;
        }

        .test-account {
            background-color: #fff;
            padding: 8px 12px;
            margin: 5px 0;
            border-radius: 4px;
            border: 1px solid #e0e0e0;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .test-account:hover {
            background-color: #f5f5f5;
        }

        .test-account strong {
            color: #4CAF50;
        }

        /* 忘記密碼模態窗 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            animation: modalShow 0.3s ease-out;
        }

        @keyframes modalShow {
            from {
                opacity: 0;
                transform: scale(0.9) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 10px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: bold;
            color: #4CAF50;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #666;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.3s;
        }

        .modal-close:hover {
            background-color: #f0f0f0;
        }

        .modal-body {
            margin-bottom: 20px;
        }

        .modal-step {
            display: none;
        }

        .modal-step.active {
            display: block;
        }

        .step-title {
            font-size: 16px;
            font-weight: bold;
            margin-bottom: 15px;
            color: #333;
        }

        .step-description {
            color: #666;
            margin-bottom: 20px;
            line-height: 1.5;
        }

        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 8px;
            color: #333;
        }

        .modal-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
            margin-bottom: 15px;
        }

        .modal-input:focus {
            border-color: #4CAF50;
        }

        .modal-input.error {
            border-color: #e74c3c;
        }

        .password-strength {
            margin: 8px 0;
            height: 4px;
            background-color: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }

        .strength-bar {
            height: 100%;
            width: 0%;
            transition: width 0.3s, background-color 0.3s;
        }

        .strength-weak { background-color: #e74c3c; width: 33%; }
        .strength-medium { background-color: #f39c12; width: 66%; }
        .strength-strong { background-color: #27ae60; width: 100%; }

        .password-help {
            font-size: 12px;
            color: #666;
            margin-bottom: 15px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn-primary {
            background-color: #4CAF50;
            color: white;
        }

        .modal-btn-primary:hover {
            background-color: #45a049;
        }

        .modal-btn-secondary {
            background-color: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .modal-btn-secondary:hover {
            background-color: #e0e0e0;
        }

        .modal-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .user-info {
            background-color: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .user-info h4 {
            color: #4CAF50;
            margin-bottom: 8px;
        }

        .user-info p {
            color: #666;
            font-size: 14px;
            margin: 5px 0;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #4CAF50;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* 響應式設計 */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .login-container {
                width: 100%;
            }
            
            .search-container {
                flex-direction: column;
                gap: 15px;
            }
            
            .search-box {
                max-width: 100%;
            }

            .modal-content {
                margin: 20px;
                padding: 20px;
            }

            .modal-buttons {
                flex-direction: column-reverse;
            }

            .modal-btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- 頂部導航 -->
    <div class="top-nav">
        <div class="container">
            <div class="nav-left">
                <a href="index.html">回首頁</a>
                <a href="#" onclick="showNewReleases()">新書推薦</a>
                <a href="#" onclick="showBestsellers()">暢銷榜</a>
                <a href="#" onclick="showEbooks()">電子書城</a>
            </div>
            <div class="nav-right">
                <a href="#" onclick="showOrders()">訂單查詢</a>
                <a href="shopping.html">購物車(<span id="cartCount">0</span>)</a>
                <a href="#" onclick="toggleLanguage()">繁體</a>
            </div>
        </div>
    </div>

    <!-- 搜尋區域 -->
    <div class="search-section">
        <div class="search-container">
            <div class="logo">
                <a href="index.html" style="text-decoration: none;">
                    <h1>書客來</h1>
                </a>
            </div>
            <div class="search-box">
                <select class="category-select" id="searchCategory">
                    <option value="all">全館</option>
                    <option value="chinese">中文書</option>
                    <option value="english">外文書</option>
                    <option value="ebook">電子書</option>
                    <option value="magazine">雜誌</option>
                </select>
                <input type="text" class="search-input" placeholder="請輸入關鍵字" id="searchInput">
                <button class="search-btn" onclick="performSearch()">🔍</button>
            </div>
        </div>
    </div>

    <!-- 主要內容 -->
    <div class="main-container">
        <!-- 左側促銷橫幅 -->
        <div class="promo-banner">
            <div class="promo-content">
                <h2>📚 會員回饋 5.27-5.28讀書日</h2>
                <p>全站分級滿$1200再</p>
                <div class="highlight">9折起</div>
                <p>部分除外</p>
                <br>
                <p>滿額最高<strong>15%</strong>回饋</p>
            </div>
        </div>

        <!-- 右側登入表單 -->
        <div class="login-container">
            <h2 class="login-title">🔑 會員登入</h2>
            
            <!-- 測試帳號提示 -->
            <div class="test-accounts">
                <h4>🧪 測試帳號（開發用）</h4>
                <div class="test-account" onclick="fillTestAccount('test@bookstore.com', '123456')">
                    <strong>一般用戶：</strong> test@bookstore.com / 123456
                </div>
                <div class="test-account" onclick="fillTestAccount('admin@bookstore.com', 'admin123')">
                    <strong>管理員：</strong> admin@bookstore.com / admin123
                </div>
            </div>
            
            <div class="error-message" id="errorMessage"></div>
            <div class="success-message" id="successMessage"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <input type="email" class="form-input" id="email" placeholder="請輸入電子郵件" required>
                </div>
                
                <div class="form-group">
                    <div class="password-container">
                        <input type="password" class="form-input" id="password" placeholder="密碼 Password" required>
                        <span class="password-toggle" onclick="togglePassword()">👁️</span>
                    </div>
                </div>
                
                <button type="submit" class="login-btn" id="loginBtn">登入</button>
            </form>
            
            <div class="qr-login">
                <a href="#" class="qr-btn" onclick="qrLogin()">
                    📱 使用 QR Code 登入
                </a>
            </div>
            
            <div class="login-links">
                <a href="#" onclick="forgotPassword()">忘記帳號密碼</a>
                <span style="color: #ccc;">|</span>
                <span>還不是會員？</span>
                <a href="register.html">加入會員</a>
            </div>
            
            <div class="social-login">
                <div class="social-title">更多登入方式</div>
                
                <button class="social-btn openpoint-btn" onclick="openpointLogin()">
                    🔴 使用 OPENPOINT 登入
                </button>
                
                <button class="social-btn facebook-btn" onclick="facebookLogin()">
                    📘 使用 Facebook 登入
                </button>
                
                <button class="social-btn line-btn" onclick="lineLogin()">
                    💬 使用 LINE 登入
                </button>
            </div>
        </div>
    </div>

    <!-- 忘記密碼模態窗 -->
    <div class="modal-overlay" id="forgotPasswordModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">🔐 重設密碼</h3>
                <button class="modal-close" onclick="closeForgotPasswordModal()">&times;</button>
            </div>
            
            <div class="modal-body">
                <!-- 步驟1：輸入電子郵件 -->
                <div class="modal-step active" id="step1">
                    <div class="step-title">步驟 1：驗證帳號</div>
                    <div class="step-description">
                        請輸入您註冊時使用的電子郵件地址，我們將為您重設密碼。
                    </div>
                    
                    <label class="form-label">電子郵件地址</label>
                    <input type="email" class="modal-input" id="forgotEmail" placeholder="請輸入您的電子郵件" required>
                    
                    <div class="error-message" id="forgotEmailError" style="margin-bottom: 0;"></div>
                </div>

                <!-- 步驟2：顯示用戶資訊並設置新密碼 -->
                <div class="modal-step" id="step2">
                    <div class="step-title">步驟 2：設置新密碼</div>
                    <div class="step-description">
                        帳號驗證成功！請設置您的新密碼。
                    </div>
                    
                    <div class="user-info" id="userInfo">
                        <!-- 用戶資訊將在這裡顯示 -->
                    </div>
                    
                    <label class="form-label">新密碼</label>
                    <div class="password-container">
                        <input type="password" class="modal-input" id="newPassword" placeholder="請輸入新密碼" required>
                        <span class="password-toggle" onclick="toggleModalPassword('newPassword')" style="top: 30%;">👁️</span>
                    </div>
                    <div class="password-strength">
                        <div class="strength-bar" id="newPasswordStrength"></div>
                    </div>
                    <div class="password-help">密碼長度至少6個字元，建議包含大小寫字母、數字和特殊符號</div>
                    
                    <label class="form-label">確認新密碼</label>
                    <div class="password-container">
                        <input type="password" class="modal-input" id="confirmNewPassword" placeholder="請再次輸入新密碼" required>
                        <span class="password-toggle" onclick="toggleModalPassword('confirmNewPassword')" style="top: 30%;">👁️</span>
                    </div>
                    
                    <div class="error-message" id="newPasswordError" style="margin-bottom: 0;"></div>
                </div>

                <!-- 步驟3：完成 -->
                <div class="modal-step" id="step3">
                    <div class="step-title">✅ 密碼重設完成</div>
                    <div class="step-description">
                        您的密碼已成功更新！您現在可以使用新密碼登入。
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <div style="font-size: 48px; color: #4CAF50; margin-bottom: 10px;">🎉</div>
                        <h4 style="color: #4CAF50;">密碼重設成功！</h4>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn modal-btn-secondary" onclick="closeForgotPasswordModal()" id="cancelBtn">取消</button>
                <button class="modal-btn modal-btn-primary" onclick="nextStep()" id="nextBtn">下一步</button>
            </div>
        </div>
    </div>

    <!-- 資料庫管理系統 -->
    <script src="js/database.js"></script>
    <script>
        // 登入管理器
        class LoginManager {
            constructor() {
                this.form = document.getElementById('loginForm');
                this.submitBtn = document.getElementById('loginBtn');
                this.init();
            }

            init() {
                // 綁定表單提交事件
                this.form.addEventListener('submit', (e) => this.handleSubmit(e));
                
                console.log('✅ 登入管理器已初始化');
            }

            async handleSubmit(e) {
                e.preventDefault();
                
                const email = document.getElementById('email').value.trim().toLowerCase();
                const password = document.getElementById('password').value;
                
                // 簡單的驗證
                if (!email || !password) {
                    this.showError('請填寫所有必填欄位');
                    return;
                }

                this.showLoading(true);

                try {
                    console.log('🔐 嘗試登入:', email);

                    // 檢查資料庫是否準備就緒
                    if (!window.bookstoreDB || !window.bookstoreDB.db) {
                        throw new Error('資料庫尚未準備就緒，請稍後再試');
                    }

                    // 資料庫驗證登入
                    const user = await window.bookstoreDB.loginUser(email, password);
                    
                    if (user) {
                        // 登入成功
                        localStorage.setItem('isLoggedIn', 'true');
                        localStorage.setItem('userEmail', user.email);
                        localStorage.setItem('userName', user.name);
                        localStorage.setItem('loginTime', new Date().toISOString());
                        
                        // 同步購物車資料
                        await this.syncCartData(user.email);
                        
                        console.log('✅ 登入成功:', user.email);
                        this.showSuccess('登入成功！正在跳轉...');
                        
                        setTimeout(() => {
                            const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || 'index.html';
                            window.location.href = redirectUrl;
                        }, 1500);
                    }
                    
                } catch (error) {
                    console.error('❌ 登入失敗:', error);
                    
                    let errorMessage = '登入失敗，請重新輸入';
                    if (error.message.includes('找不到此用戶')) {
                        errorMessage = '找不到此用戶，請檢查電子郵件或先註冊';
                    } else if (error.message.includes('密碼錯誤')) {
                        errorMessage = '密碼錯誤，請重新輸入';
                    } else if (error.message.includes('帳號已被停用')) {
                        errorMessage = '帳號已被停用，請聯絡客服';
                    } else if (error.message.includes('資料庫尚未準備就緒')) {
                        errorMessage = '系統正在載入中，請稍後再試';
                    }
                    
                    this.showError(errorMessage);
                } finally {
                    this.showLoading(false);
                }
            }

            async syncCartData(userEmail) {
                try {
                    // 獲取本地購物車資料
                    const localCartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
                    
                    // 獲取資料庫中的購物車資料
                    const dbCartItems = await window.bookstoreDB.getCart(userEmail);
                    
                    // 合併購物車資料（優先保留本地資料）
                    let mergedCart = [...localCartItems];
                    
                    dbCartItems.forEach(dbItem => {
                        const existingItem = mergedCart.find(item => item.id === dbItem.id);
                        if (!existingItem) {
                            mergedCart.push(dbItem);
                        }
                    });
                    
                    // 更新本地和資料庫
                    localStorage.setItem('cartItems', JSON.stringify(mergedCart));
                    await window.bookstoreDB.saveCart(userEmail, mergedCart);
                    
                    console.log('✅ 購物車資料同步完成');
                } catch (error) {
                    console.warn('⚠️ 購物車同步失敗:', error);
                }
            }

            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                const successDiv = document.getElementById('successMessage');
                successDiv.style.display = 'none';
            }

            showSuccess(message) {
                const successDiv = document.getElementById('successMessage');
                successDiv.textContent = message;
                successDiv.style.display = 'block';
                
                const errorDiv = document.getElementById('errorMessage');
                errorDiv.style.display = 'none';
            }

            showLoading(isLoading) {
                if (isLoading) {
                    this.submitBtn.disabled = true;
                    this.submitBtn.innerHTML = '<span class="loading-spinner"></span>登入中...';
                } else {
                    this.submitBtn.disabled = false;
                    this.submitBtn.textContent = '登入';
                }
            }
        }

        // 忘記密碼管理器
        class ForgotPasswordManager {
            constructor() {
                this.currentStep = 1;
                this.foundUser = null;
                this.init();
            }

            init() {
                // 綁定密碼強度檢查
                const newPasswordInput = document.getElementById('newPassword');
                if (newPasswordInput) {
                    newPasswordInput.addEventListener('input', (e) => this.checkPasswordStrength(e));
                }

                console.log('✅ 忘記密碼管理器已初始化');
            }

            async nextStep() {
                const nextBtn = document.getElementById('nextBtn');
                
                if (this.currentStep === 1) {
                    // 驗證電子郵件
                    const email = document.getElementById('forgotEmail').value.trim().toLowerCase();
                    
                    if (!email) {
                        this.showStepError('forgotEmailError', '請輸入電子郵件地址');
                        return;
                    }

                    if (!this.isValidEmail(email)) {
                        this.showStepError('forgotEmailError', '請輸入有效的電子郵件格式');
                        return;
                    }

                    // 顯示載入狀態
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = '<span class="loading-spinner"></span>驗證中...';

                    try {
                        // 檢查資料庫是否準備就緒
                        if (!window.bookstoreDB || !window.bookstoreDB.isReady) {
                            throw new Error('資料庫尚未準備就緒');
                        }

                        // 查找用戶
                        const user = await window.bookstoreDB.getUser(email);
                        
                        if (!user) {
                            this.showStepError('forgotEmailError', '找不到此電子郵件對應的帳號，請檢查後重新輸入');
                            return;
                        }

                        if (!user.isActive) {
                            this.showStepError('forgotEmailError', '此帳號已被停用，請聯絡客服');
                            return;
                        }

                        this.foundUser = user;
                        this.goToStep(2);
                        
                    } catch (error) {
                        console.error('❌ 驗證用戶失敗:', error);
                        this.showStepError('forgotEmailError', '驗證過程發生錯誤，請稍後再試');
                    } finally {
                        nextBtn.disabled = false;
                        nextBtn.textContent = '下一步';
                    }

                } else if (this.currentStep === 2) {
                    // 設置新密碼
                    const newPassword = document.getElementById('newPassword').value;
                    const confirmPassword = document.getElementById('confirmNewPassword').value;

                    if (!this.validateNewPassword(newPassword, confirmPassword)) {
                        return;
                    }

                    // 顯示載入狀態
                    nextBtn.disabled = true;
                    nextBtn.innerHTML = '<span class="loading-spinner"></span>更新中...';

                    try {
                        // 更新密碼
                        await window.bookstoreDB.updateUser(this.foundUser.email, {
                            password: newPassword,
                            updatedAt: new Date().toISOString()
                        });

                        console.log('✅ 密碼重設成功:', this.foundUser.email);
                        this.goToStep(3);
                        
                    } catch (error) {
                        console.error('❌ 更新密碼失敗:', error);
                        this.showStepError('newPasswordError', '密碼更新失敗，請稍後再試');
                    } finally {
                        nextBtn.disabled = false;
                        nextBtn.textContent = '完成';
                    }

                } else if (this.currentStep === 3) {
                    // 完成，關閉模態窗
                    closeForgotPasswordModal();
                }
            }

            goToStep(step) {
                // 隱藏所有步驟
                document.querySelectorAll('.modal-step').forEach(stepEl => {
                    stepEl.classList.remove('active');
                });

                // 清除錯誤訊息
                this.clearStepErrors();

                // 顯示目標步驟
                document.getElementById(`step${step}`).classList.add('active');
                this.currentStep = step;

                const nextBtn = document.getElementById('nextBtn');
                const cancelBtn = document.getElementById('cancelBtn');

                if (step === 2) {
                    // 顯示用戶資訊
                    this.displayUserInfo();
                    nextBtn.textContent = '重設密碼';
                } else if (step === 3) {
                    nextBtn.textContent = '完成';
                    cancelBtn.style.display = 'none';
                } else {
                    nextBtn.textContent = '下一步';
                }
            }

            displayUserInfo() {
                const userInfoDiv = document.getElementById('userInfo');
                const registrationDate = new Date(this.foundUser.registrationDate).toLocaleDateString('zh-TW');
                
                userInfoDiv.innerHTML = `
                    <h4>📋 帳號資訊</h4>
                    <p><strong>電子郵件：</strong>${this.foundUser.email}</p>
                    <p><strong>姓名：</strong>${this.foundUser.name}</p>
                    <p><strong>註冊日期：</strong>${registrationDate}</p>
                `;
            }

            validateNewPassword(newPassword, confirmPassword) {
                let isValid = true;

                if (!newPassword) {
                    this.showStepError('newPasswordError', '請輸入新密碼');
                    isValid = false;
                } else if (newPassword.length < 6) {
                    this.showStepError('newPasswordError', '密碼長度至少6個字元');
                    isValid = false;
                } else if (!confirmPassword) {
                    this.showStepError('newPasswordError', '請確認新密碼');
                    isValid = false;
                } else if (newPassword !== confirmPassword) {
                    this.showStepError('newPasswordError', '兩次輸入的密碼不一致');
                    isValid = false;
                }

                return isValid;
            }

            checkPasswordStrength(e) {
                const password = e.target.value;
                const strengthBar = document.getElementById('newPasswordStrength');
                
                let strength = 0;
                
                if (password.length >= 6) strength++;
                if (password.match(/[a-z]/) && password.match(/[A-Z]/)) strength++;
                if (password.match(/[0-9]/)) strength++;
                if (password.match(/[^a-zA-Z0-9]/)) strength++;

                strengthBar.className = 'strength-bar';
                
                if (strength >= 3) {
                    strengthBar.classList.add('strength-strong');
                } else if (strength >= 2) {
                    strengthBar.classList.add('strength-medium');
                } else if (strength >= 1) {
                    strengthBar.classList.add('strength-weak');
                }
            }

            showStepError(elementId, message) {
                const errorDiv = document.getElementById(elementId);
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }

            clearStepErrors() {
                document.querySelectorAll('.modal-body .error-message').forEach(errorDiv => {
                    errorDiv.style.display = 'none';
                    errorDiv.textContent = '';
                });
            }

            isValidEmail(email) {
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return emailRegex.test(email);
            }

            reset() {
                this.currentStep = 1;
                this.foundUser = null;
                
                // 重置表單
                document.getElementById('forgotEmail').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmNewPassword').value = '';
                
                // 重置密碼強度指示器
                const strengthBar = document.getElementById('newPasswordStrength');
                if (strengthBar) {
                    strengthBar.className = 'strength-bar';
                }
                
                // 顯示第一步
                this.goToStep(1);
                
                // 重置按鈕
                const nextBtn = document.getElementById('nextBtn');
                const cancelBtn = document.getElementById('cancelBtn');
                nextBtn.textContent = '下一步';
                nextBtn.disabled = false;
                cancelBtn.style.display = 'inline-block';
                
                this.clearStepErrors();
            }
        }

        // 全域變數
        let forgotPasswordManager;

        // 檢查是否已經登入
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userEmail = localStorage.getItem('userEmail');
            
            if (isLoggedIn === 'true' && userEmail) {
                // 已經登入，重定向到指定頁面或首頁
                const redirectUrl = new URLSearchParams(window.location.search).get('redirect') || 'index.html';
                window.location.href = redirectUrl;
            }
        }

        // 更新購物車數量顯示
        function updateCartDisplay() {
            const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            const cartCount = cartItems.reduce((total, item) => total + item.quantity, 0);
            document.getElementById('cartCount').textContent = cartCount;
        }

        // 填入測試帳號
        function fillTestAccount(email, password) {
            document.getElementById('email').value = email;
            document.getElementById('password').value = password;
        }

        // 密碼顯示/隱藏切換
        function togglePassword() {
            const passwordInput = document.getElementById('password');
            const toggleBtn = document.querySelector('.password-toggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        }

        // 模態窗密碼顯示/隱藏切換
        function toggleModalPassword(inputId) {
            const passwordInput = document.getElementById(inputId);
            const toggleBtn = passwordInput.parentNode.querySelector('.password-toggle');
            
            if (passwordInput.type === 'password') {
                passwordInput.type = 'text';
                toggleBtn.textContent = '🙈';
            } else {
                passwordInput.type = 'password';
                toggleBtn.textContent = '👁️';
            }
        }

        // QR Code 登入
        function qrLogin() {
            alert('QR Code 登入功能開發中...');
        }

        // 忘記密碼
        function forgotPassword() {
            const modal = document.getElementById('forgotPasswordModal');
            modal.style.display = 'flex';
            
            if (forgotPasswordManager) {
                forgotPasswordManager.reset();
            }
        }

        // 關閉忘記密碼模態窗
        function closeForgotPasswordModal() {
            const modal = document.getElementById('forgotPasswordModal');
            modal.style.display = 'none';
        }

        // 下一步
        function nextStep() {
            if (forgotPasswordManager) {
                forgotPasswordManager.nextStep();
            }
        }

        // 點擊模態窗外部關閉
        document.getElementById('forgotPasswordModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeForgotPasswordModal();
            }
        });

        // 第三方登入
        function openpointLogin() {
            alert('OPENPOINT 登入功能開發中...');
        }

        function facebookLogin() {
            alert('Facebook 登入功能開發中...');
        }

        function lineLogin() {
            alert('LINE 登入功能開發中...');
        }

        // 搜尋功能
        function performSearch() {
            const category = document.getElementById('searchCategory').value;
            const keyword = document.getElementById('searchInput').value;
            
            if (keyword.trim() === '') {
                alert('請輸入搜尋關鍵字');
                return;
            }
            
            // 跳轉到搜尋結果頁面
            const searchUrl = `search-results.html?q=${encodeURIComponent(keyword)}&category=${encodeURIComponent(category)}`;
            window.location.href = searchUrl;
        }

        // 導航功能
        function showNewReleases() {
            document.getElementById('searchInput').value = '新書';
            performSearch();
        }

        function showBestsellers() {
            document.getElementById('searchInput').value = '暢銷書';
            performSearch();
        }

        function showEbooks() {
            document.getElementById('searchCategory').value = 'ebook';
            document.getElementById('searchInput').value = '電子書';
            performSearch();
        }

        function showOrders() {
            // 檢查登入狀態，未登入則跳轉到登入頁面
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html?redirect=ordersearch.html';
                return;
            }
            window.location.href = 'ordersearch.html';
        }

        function toggleLanguage() {
            alert('語言切換功能開發中...');
        }

        // 搜尋框 Enter 鍵支援
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // 頁面載入時初始化
        document.addEventListener('DOMContentLoaded', function() {
            checkLoginStatus();
            updateCartDisplay();
            
            // 等待資料庫準備就緒後初始化管理器
            const initManagers = () => {
                if (window.bookstoreDB) {
                    new LoginManager();
                    forgotPasswordManager = new ForgotPasswordManager();
                    console.log('✅ 登入頁面初始化完成');
                } else {
                    // 如果資料庫還沒準備好，稍後再試
                    setTimeout(initManagers, 100);
                }
            };
            
            initManagers();
        });
    </script>
</body>
</html>