<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è³¼ç‰©è»Š - æ›¸å®¢ä¾†ç·šä¸Šæ›¸åº—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "å¾®è»Ÿé›…é»‘", Arial, sans-serif;
            background-color: #f5f5f5;
        }

        /* é ‚éƒ¨å°èˆª */
        .top-nav {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 0;
        }

        .top-nav .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 13px;
        }

        .nav-left a, .nav-right a {
            color: #666;
            text-decoration: none;
            margin: 0 10px;
        }

        .nav-left a:hover, .nav-right a:hover {
            color: #4CAF50;
        }

        .nav-right .user-info {
            color: #4CAF50;
            font-weight: bold;
        }

        /* æœå°‹å€åŸŸ */
        .search-section {
            background-color: #fff;
            padding: 15px 0;
            border-bottom: 2px solid #4CAF50;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            margin-right: 30px;
        }

        .logo h1 {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
        }

        .search-box {
            flex: 1;
            display: flex;
            max-width: 500px;
        }

        .category-select {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-right: none;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px 0 0 4px;
            outline: none;
        }

        .search-input {
            flex: 1;
            border: 1px solid #ddd;
            border-left: none;
            border-right: none;
            padding: 8px 12px;
            font-size: 14px;
            outline: none;
        }

        .search-btn {
            background-color: #4CAF50;
            color: white;
            border: 1px solid #4CAF50;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        /* è­¦å‘Šæ©«å¹… */
        .warning-banner {
            background-color: #fff3cd;
            border: 1px solid #ffd700;
            padding: 10px;
            text-align: center;
            font-size: 13px;
            color: #856404;
        }

        /* ä¸»è¦å…§å®¹ */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* å„ªæƒ æ´»å‹•æ©«å¹… */
        .promo-info {
            background-color: #e8f5e8;
            border: 1px solid #4CAF50;
            border-radius: 4px;
            padding: 15px;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .promo-info:hover {
            background-color: #d4f0d4;
        }

        .promo-info .promo-title {
            color: #4CAF50;
            font-weight: bold;
            font-size: 14px;
        }

        .promo-info .promo-detail {
            color: #666;
            font-size: 12px;
            margin-top: 5px;
        }

        /* è³¼ç‰©è»Šæ¨™ç±¤ */
        .cart-tabs {
            display: flex;
            background-color: #fff;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 20px;
        }

        .cart-tab {
            flex: 1;
            padding: 15px;
            background-color: #f8f8f8;
            border: none;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }

        .cart-tab.active {
            background-color: #4CAF50;
            color: white;
        }

        .cart-tab:hover:not(.active) {
            background-color: #e0e0e0;
        }

        /* è³¼ç‰©è»Šå…§å®¹ */
        .cart-content {
            background-color: #fff;
            border-radius: 4px;
            overflow: hidden;
        }

        /* å•†å“è¡¨æ ¼ */
        .cart-table {
            width: 100%;
            border-collapse: collapse;
        }

        .cart-table thead {
            background-color: #f8f8f8;
        }

        .cart-table th {
            padding: 15px 10px;
            text-align: center;
            font-weight: bold;
            border-bottom: 1px solid #e0e0e0;
            font-size: 13px;
        }

        .cart-table td {
            padding: 15px 10px;
            border-bottom: 1px solid #f0f0f0;
            vertical-align: middle;
            font-size: 13px;
        }

        .cart-table tbody tr:hover {
            background-color: #f9f9f9;
        }

        /* å•†å“åœ–ç‰‡ */
        .product-image {
            width: 60px;
            height: 80px;
            background-color: #f0f0f0;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 10px;
        }

        /* å•†å“è³‡è¨Š */
        .product-info {
            text-align: left;
        }

        .product-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
            line-height: 1.3;
        }

        .product-note {
            color: #666;
            font-size: 11px;
        }

        /* åƒ¹æ ¼é¡¯ç¤º */
        .price-info {
            text-align: right;
        }

        .current-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 16px;
        }

        .original-price {
            color: #999;
            text-decoration: line-through;
            font-size: 12px;
            margin-top: 2px;
        }

        /* æ•¸é‡æ§åˆ¶ */
        .quantity-control {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .qty-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background-color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 3px;
            transition: all 0.3s;
        }

        .qty-btn:hover {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .qty-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .qty-input {
            width: 50px;
            height: 30px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 3px;
            outline: none;
        }

        /* å°è¨ˆ */
        .subtotal {
            text-align: right;
            color: #e74c3c;
            font-weight: bold;
            font-size: 14px;
        }

        /* åº«å­˜ç‹€æ…‹ */
        .stock-status {
            text-align: center;
            color: #4CAF50;
            font-weight: bold;
        }

        .stock-status.out-of-stock {
            color: #e74c3c;
        }

        /* æ“ä½œæŒ‰éˆ• */
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 5px;
            align-items: center;
        }

        .action-btn {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .action-btn:hover {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .remove-btn {
            color: #e74c3c;
            border-color: #e74c3c;
        }

        .remove-btn:hover {
            background-color: #e74c3c;
            color: white;
        }

        /* åº•éƒ¨æ“ä½œå€ */
        .cart-footer {
            background-color: #f8f8f8;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .bulk-actions {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
        }

        .bulk-btn {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .bulk-btn:hover {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        .special-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .cart-summary {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .total-info {
            text-align: right;
        }

        .total-items {
            color: #666;
            font-size: 13px;
        }

        .total-amount {
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
            margin-top: 5px;
        }

        /* çµå¸³æŒ‰éˆ• */
        .checkout-buttons {
            display: flex;
            gap: 10px;
        }

        .checkout-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s;
        }

        .checkout-btn.primary {
            background-color: #ffc107;
            color: #333;
        }

        .checkout-btn.primary:hover {
            background-color: #ffb300;
        }

        .checkout-btn.secondary {
            background-color: #6c757d;
            color: white;
        }

        .checkout-btn.secondary:hover {
            background-color: #5a6268;
        }

        .checkout-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é‡è¦æé†’ */
        .important-notes {
            background-color: #fff;
            border-radius: 4px;
            padding: 20px;
            margin-top: 20px;
        }

        .notes-title {
            background-color: #4CAF50;
            color: white;
            padding: 10px 15px;
            margin: -20px -20px 15px -20px;
            font-weight: bold;
            font-size: 14px;
        }

        .notes-content {
            color: #666;
            font-size: 13px;
            line-height: 1.6;
        }

        .notes-content ul {
            margin-left: 20px;
        }

        .notes-content li {
            margin-bottom: 8px;
        }

        .notes-content a {
            color: #4CAF50;
            text-decoration: none;
        }

        .notes-content a:hover {
            text-decoration: underline;
        }

        /* ç©ºè³¼ç‰©è»Š */
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
            background-color: #fff;
            border-radius: 4px;
        }

        .empty-cart h3 {
            color: #666;
            font-size: 18px;
            margin-bottom: 15px;
        }

        .empty-cart p {
            color: #999;
            margin-bottom: 25px;
        }

        .shop-now-btn {
            background-color: #4CAF50;
            color: white;
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
            font-size: 14px;
            transition: background-color 0.3s;
            margin: 0 5px;
        }

        .shop-now-btn:hover {
            background-color: #45a049;
        }

        /* çµå¸³å½ˆå‡ºè¦–çª— */
        .checkout-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .checkout-modal.show {
            display: flex;
        }

        .checkout-modal-content {
            background-color: white;
            border-radius: 12px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            position: relative;
            transform: scale(0.8);
            transition: transform 0.3s ease;
        }

        .checkout-modal.show .checkout-modal-content {
            transform: scale(1);
        }

        .checkout-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }

        .checkout-close:hover {
            color: #666;
        }

        .checkout-modal-title {
            color: #4CAF50;
            font-size: 20px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }

        .checkout-form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .checkout-input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            transition: border-color 0.3s;
        }

        .checkout-input:focus {
            border-color: #4CAF50;
        }

        .checkout-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            outline: none;
            background-color: white;
        }

        .order-summary {
            background-color: #f8f8f8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }

        .order-summary h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 13px;
        }

        .order-total {
            border-top: 1px solid #ddd;
            padding-top: 10px;
            margin-top: 10px;
            font-weight: bold;
            color: #e74c3c;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .main-container {
                padding: 0 10px;
            }
            
            .search-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .cart-table {
                font-size: 11px;
            }
            
            .cart-table th,
            .cart-table td {
                padding: 8px 5px;
            }
            
            .cart-footer {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .bulk-actions {
                flex-direction: column;
                gap: 10px;
            }

            .special-actions {
                flex-direction: column;
            }
            
            .checkout-buttons {
                justify-content: center;
            }

            .checkout-modal-content {
                width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <div class="top-nav">
        <div class="container">
            <div class="nav-left">
                <a href="index.html">å›é¦–é </a>
                <a href="#" onclick="showNewReleases()">æ–°æ›¸æ¨è–¦</a>
                <a href="#" onclick="showBestsellers()">æš¢éŠ·æ¦œ</a>
                <a href="#" onclick="showEbooks()">é›»å­æ›¸åŸ</a>
            </div>
            <div class="nav-right">
                <span class="user-info" id="userInfo">æœªç™»å…¥</span>
                <a href="#" id="loginLogoutBtn" onclick="handleLoginLogout()">æœƒå“¡ç™»å…¥</a>
                <a href="#" onclick="showOrders()">è¨‚å–®æŸ¥è©¢</a>
                <a href="#" onclick="toggleLanguage()">ç¹é«”</a>
            </div>
        </div>
    </div>

    <!-- æœå°‹å€åŸŸ -->
    <div class="search-section">
        <div class="search-container">
            <div class="logo">
                <a href="index.html" style="text-decoration: none;">
                    <h1>æ›¸å®¢ä¾†</h1>
                </a>
            </div>
            <div class="search-box">
                <select class="category-select">
                    <option value="all">å…¨é¤¨</option>
                    <option value="chinese">ä¸­æ–‡æ›¸</option>
                    <option value="english">å¤–æ–‡æ›¸</option>
                    <option value="ebook">é›»å­æ›¸</option>
                </select>
                <input type="text" class="search-input" placeholder="æ¯æ—¥å£è¢‹99">
                <button class="search-btn">ğŸ”</button>
            </div>
        </div>
    </div>

    <!-- è­¦å‘Šæ©«å¹… -->
    <div class="warning-banner" id="warningBanner">
        å› æ‡‰è¿‘æœŸå°ç£å‡ºå£æ³•è¦ä¿®è¨‚ï¼Œéƒ¨åˆ†å•†å“æ¶‰åŠåŸç”¢åœ°æˆ–ç¨…é—œé™åˆ¶ï¼Œæš«ä¸æä¾›å¯„é€è‡³ç¾åœ‹çš„æœå‹™ã€‚
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-container">
        <!-- å„ªæƒ æ´»å‹• -->
        <div class="promo-info" onclick="togglePromoDetail()">
            <div class="promo-title">
                ğŸ¯ å„ªæƒ è¨Šæ¯
            </div>
            <div class="promo-detail" id="promoDetail">
                ğŸ“š 5/27-5/28è®€æ›¸æ—¥å…¨ç«™åˆ†ç´šæ»¿$1200å†9æŠ˜èµ·(éƒ¨åˆ†é™¤å¤–)ï¼Œæ»¿é¡æœ€é«˜15%å›é¥‹
            </div>
        </div>

        <!-- è³¼ç‰©è»Šæ¨™ç±¤ -->
        <div class="cart-tabs">
            <button class="cart-tab active" onclick="switchTab('purchase', this)">è³¼ç‰©æ˜ç´°</button>
            <button class="cart-tab" onclick="switchTab('free', this)">å…è²»è´ˆå“</button>
            <button class="cart-tab" onclick="switchTab('points', this)">é»æ•¸å›é¥‹</button>
            <button class="cart-tab" onclick="switchTab('next', this)">ä¸‹æ¬¡å†è²·æ¸…å–®</button>
            <button class="cart-tab" onclick="switchTab('notice', this)">æ³¨æ„äº‹é …</button>
        </div>

        <!-- è³¼ç‰©è»Šå…§å®¹ -->
        <div class="cart-content" id="cartContent">
            <!-- è³¼ç‰©è»Šå•†å“è¡¨æ ¼ -->
            <div id="cartTableContainer">
                <table class="cart-table">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                            </th>
                            <th>å•†å“æ˜ç´°</th>
                            <th>å„ªæƒ åƒ¹/é»æ•¸å…Œæ›åƒ¹</th>
                            <th>æ•¸é‡</th>
                            <th>å°è¨ˆ</th>
                            <th>åº«å­˜</th>
                            <th>è®Šæ›´æ˜ç´°</th>
                        </tr>
                    </thead>
                    <tbody id="cartTableBody">
                        <!-- è³¼ç‰©è»Šå•†å“å°‡é€šé JavaScript è¼‰å…¥ -->
                    </tbody>
                </table>
            </div>

            <!-- è³¼ç‰©è»Šåº•éƒ¨æ“ä½œ -->
            <div class="cart-footer" id="cartFooter">
                <div class="bulk-actions">
                    <button class="bulk-btn" onclick="addSelectedToNextTime()">æ•´æ‰¹æ”¾å…¥ä¸‹æ¬¡å†è²·</button>
                    <button class="bulk-btn" onclick="removeSelected()">æ•´æ‰¹åˆªé™¤</button>
                    <div class="special-actions">
                        <button class="bulk-btn" onclick="addTestProducts()" 
                                style="background-color: #4CAF50; color: white; border-color: #4CAF50;">
                            ğŸ“š æ·»åŠ æ¸¬è©¦å•†å“
                        </button>
                        <button class="bulk-btn" onclick="syncCartWithDatabase()" 
                                style="background-color: #2196f3; color: white; border-color: #2196f3;">
                            ğŸ”„ åŒæ­¥è³¼ç‰©è»Š
                        </button>
                        <button class="bulk-btn" onclick="clearCart()" 
                                style="background-color: #f44336; color: white; border-color: #f44336;">
                            ğŸ—‘ï¸ æ¸…ç©ºè³¼ç‰©è»Š
                        </button>
                    </div>
                </div>
                
                <div class="cart-summary">
                    <div class="total-info">
                        <div class="total-items">å…± <span id="totalItems">0</span> é …å•†å“ï¼Œæ•¸é‡ <span id="totalQuantity">0</span> å€‹</div>
                        <div class="total-amount">é‡‘é¡/å°è¨ˆï¼šNT$ <span id="totalAmount">0</span> å…ƒ</div>
                    </div>
                    
                    <div class="checkout-buttons">
                        <button class="checkout-btn secondary" onclick="continueShopping()">å›é¦–é </button>
                        <button class="checkout-btn secondary" onclick="goToOverseas()">æµ·å¤–çµå¸³</button>
                        <button class="checkout-btn primary" onclick="proceedToCheckout()" id="checkoutBtn">åœ‹å…§çµå¸³</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç©ºè³¼ç‰©è»Š -->
        <div class="empty-cart" id="emptyCart" style="display: none;">
            <h3>ğŸ›’ æ‚¨çš„è³¼ç‰©è»Šæ˜¯ç©ºçš„</h3>
            <p>å¿«å»æŒ‘é¸æ‚¨å–œæ„›çš„æ›¸ç±å§ï¼</p>
            <div style="margin: 20px 0; display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button onclick="addTestProducts()" class="shop-now-btn" 
                        style="background-color: #4CAF50;">
                    ğŸ“š è¼‰å…¥æ¸¬è©¦å•†å“
                </button>
                <a href="index.html" class="shop-now-btn">
                    ğŸ  å›åˆ°é¦–é è³¼ç‰©
                </a>
                <button onclick="syncCartWithDatabase()" class="shop-now-btn" 
                        style="background-color: #2196f3;">
                    ğŸ”„ åŒæ­¥è³¼ç‰©è»Šè³‡æ–™
                </button>
            </div>
        </div>

        <!-- é‡è¦æé†’ -->
        <div class="important-notes">
            <div class="notes-title">é‡è¦æé†’</div>
            <div class="notes-content">
                <ul>
                    <li>è³¼ç‰©è»Šä¸­çš„å•†å“æœƒè‡ªå‹•ä¿å­˜åˆ°æ‚¨çš„å¸³æˆ¶ä¸­ï¼Œå¯åœ¨ä¸åŒè£ç½®é–“åŒæ­¥ã€‚</li>
                    <li>å•†å“ç¸½ä»¶æ•¸å¤§æ–¼æˆ–å¤šæ–¼15é …ï¼Œå¯èƒ½ä¸é©ç”¨ã€7-11å–è²¨ã€ã€‚(<a href="#" onclick="showShippingInfo()">èªªæ˜</a>)</li>
                    <li>çµå¸³é¸é …è‹¥ç„¡ç¾ã€æµ·å¤–åº—å–ã€ï¼Œå¯èƒ½æ˜¯è³¼è²·å•†å“ä¸é©ç”¨æ­¤æœå‹™ã€‚(<a href="#" onclick="showOverseasInfo()">èªªæ˜</a>)</li>
                    <li>æµ·å¤–éƒµè³‡è«‹å–®ç®—ã€‚(<a href="#" onclick="showShippingCost()">èªªæ˜</a>)</li>
                    <li><strong>ğŸ”„ å¢å¼·åŠŸèƒ½</strong>ï¼šè³¼ç‰©è»Šè³‡æ–™æœƒè‡ªå‹•èˆ‡è³‡æ–™åº«åŒæ­¥ï¼Œç™»å…¥å¾Œå¯åœ¨ä¸åŒè£ç½®æŸ¥çœ‹ã€‚</li>
                </ul>
            </div>
        </div>
    </div>

    <!-- çµå¸³å½ˆå‡ºè¦–çª— -->
    <div class="checkout-modal" id="checkoutModal">
        <div class="checkout-modal-content">
            <button class="checkout-close" onclick="closeCheckoutModal()">&times;</button>
            <h3 class="checkout-modal-title">ğŸ›’ ç¢ºèªçµå¸³</h3>
            
            <form id="checkoutForm" onsubmit="submitOrder(event)">
                <input type="text" class="checkout-input" id="shippingName" placeholder="æ”¶ä»¶äººå§“å" required>
                <input type="tel" class="checkout-input" id="shippingPhone" placeholder="æ”¶ä»¶äººé›»è©±" required>
                <input type="text" class="checkout-input" id="shippingAddress" placeholder="æ”¶ä»¶åœ°å€" required>
                
                <select class="checkout-select" id="paymentMethod" required>
                    <option value="">è«‹é¸æ“‡ä»˜æ¬¾æ–¹å¼</option>
                    <option value="credit_card">ä¿¡ç”¨å¡</option>
                    <option value="atm">ATMè½‰å¸³</option>
                    <option value="convenience_store">è¶…å•†å–è²¨ä»˜æ¬¾</option>
                    <option value="line_pay">LINE Pay</option>
                </select>
                
                <div class="order-summary">
                    <h4>ğŸ“‹ è¨‚å–®æ‘˜è¦</h4>
                    <div id="orderSummaryItems"></div>
                    <div class="order-total">
                        <div class="order-item">
                            <span>ç¸½è¨ˆï¼š</span>
                            <span>NT$ <span id="orderTotalAmount">0</span></span>
                        </div>
                    </div>
                </div>
                
                <button type="submit" class="checkout-btn primary" style="width: 100%; margin-top: 15px;" id="submitOrderBtn">
                    ğŸ’³ ç¢ºèªä¸‹å–®
                </button>
                <button type="button" class="checkout-btn secondary" style="width: 100%; margin-top: 10px;" onclick="closeCheckoutModal()">
                    å–æ¶ˆ
                </button>
            </form>
        </div>
    </div>

    <!-- è³‡æ–™åº«ç®¡ç†ç³»çµ± -->
    <script src="js/database.js"></script>
    <script>
        // å¢å¼·ç‰ˆè³¼ç‰©è»Šç®¡ç†å™¨
        class EnhancedCartManager {
            constructor() {
                this.cartItems = [];
                this.currentUser = null;
                this.isLoggedIn = false;
                this.init();
            }

            async init() {
                console.log('ğŸ›’ åˆå§‹åŒ–å¢å¼·ç‰ˆè³¼ç‰©è»Šç®¡ç†å™¨');
                
                // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
                this.checkLoginStatus();
                
                // ç­‰å¾…è³‡æ–™åº«æº–å‚™å°±ç·’
                if (window.bookstoreDB && window.bookstoreDB.db) {
                    await this.loadCartData();
                } else {
                    // ç›£è½è³‡æ–™åº«å°±ç·’äº‹ä»¶
                    window.addEventListener('databaseReady', async () => {
                        await this.loadCartData();
                    });
                }
                
                this.updateCartDisplay();
                console.log('âœ… å¢å¼·ç‰ˆè³¼ç‰©è»Šç®¡ç†å™¨åˆå§‹åŒ–å®Œæˆ');
            }

            checkLoginStatus() {
                const isLoggedIn = localStorage.getItem('isLoggedIn');
                const userEmail = localStorage.getItem('userEmail');
                const userName = localStorage.getItem('userName');

                this.isLoggedIn = (isLoggedIn === 'true' && userEmail);
                this.currentUser = userEmail;

                if (this.isLoggedIn) {
                    document.getElementById('userInfo').textContent = `æ­¡è¿ï¼Œ${userName || userEmail}`;
                    document.getElementById('loginLogoutBtn').textContent = 'ç™»å‡º';
                } else {
                    document.getElementById('userInfo').textContent = 'æœªç™»å…¥';
                    document.getElementById('loginLogoutBtn').textContent = 'æœƒå“¡ç™»å…¥';
                }
            }

            async loadCartData() {
                try {
                    if (this.isLoggedIn && this.currentUser) {
                        console.log('ğŸ”„ è¼‰å…¥å·²ç™»å…¥ç”¨æˆ¶çš„è³¼ç‰©è»Šè³‡æ–™');
                        
                        // å¾è³‡æ–™åº«ç²å–è³¼ç‰©è»Šè³‡æ–™
                        const dbCartItems = await window.bookstoreDB.getCart(this.currentUser);
                        
                        // å¾æœ¬åœ°ç²å–è³¼ç‰©è»Šè³‡æ–™
                        const localCartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
                        
                        // åˆä½µè³‡æ–™ï¼ˆå„ªå…ˆä¿ç•™æœ¬åœ°è³‡æ–™ï¼‰
                        let mergedCart = [...localCartItems];
                        
                        dbCartItems.forEach(dbItem => {
                            const existingItem = mergedCart.find(item => item.id === dbItem.id);
                            if (!existingItem) {
                                mergedCart.push(dbItem);
                            }
                        });
                        
                        this.cartItems = mergedCart;
                        
                        // æ›´æ–°æœ¬åœ°å’Œè³‡æ–™åº«
                        localStorage.setItem('cartItems', JSON.stringify(this.cartItems));
                        if (this.cartItems.length > 0) {
                            await window.bookstoreDB.saveCart(this.currentUser, this.cartItems);
                        }
                        
                        console.log('âœ… è³¼ç‰©è»Šè³‡æ–™è¼‰å…¥ä¸¦åŒæ­¥å®Œæˆ');
                    } else {
                        console.log('ğŸ‘¤ æœªç™»å…¥ç”¨æˆ¶ï¼Œè¼‰å…¥æœ¬åœ°è³¼ç‰©è»Šè³‡æ–™');
                        
                        // æœªç™»å…¥ï¼Œåªä½¿ç”¨æœ¬åœ°è³‡æ–™
                        const localCartItems = localStorage.getItem('cartItems');
                        
                        if (localCartItems) {
                            this.cartItems = JSON.parse(localCartItems);
                        } else {
                            // å¦‚æœæ²’æœ‰æœ¬åœ°è³‡æ–™ï¼Œè¼‰å…¥ä¸€äº›æ¸¬è©¦è³‡æ–™
                            this.cartItems = this.getDefaultTestItems();
                            this.saveCartData();
                        }
                    }
                } catch (error) {
                    console.error('âŒ è¼‰å…¥è³¼ç‰©è»Šè³‡æ–™å¤±æ•—:', error);
                    
                    // è¼‰å…¥å¤±æ•—æ™‚ä½¿ç”¨æœ¬åœ°æˆ–æ¸¬è©¦è³‡æ–™
                    const localCartItems = localStorage.getItem('cartItems');
                    if (localCartItems) {
                        this.cartItems = JSON.parse(localCartItems);
                    } else {
                        this.cartItems = this.getDefaultTestItems();
                        this.saveCartData();
                    }
                }

                this.updateCartDisplay();
            }

            getDefaultTestItems() {
                return [
                    {
                        id: 'book001',
                        title: 'å“ˆåˆ©æ³¢ç‰¹(3)ï¼šé˜¿èŒ²å¡ç­çš„é€ƒçŠ¯ã€ç¹é«”ä¸­æ–‡ç‰ˆ20é€±å¹´ç´€å¿µã€‘',
                        note: 'å„ªæƒ æœŸé™è‡³2025/06/30',
                        price: 410,
                        originalPrice: 500,
                        quantity: 1,
                        stock: 'æœ‰',
                        selected: true,
                        addedAt: new Date().toISOString()
                    },
                    {
                        id: 'book002',
                        title: 'ä¸‰é«”ç³»åˆ—é¸éŠ€ç°½åå¥—æ›¸',
                        note: 'å„ªæƒ æœŸé™è‡³2025/06/30',
                        price: 1012,
                        originalPrice: 1200,
                        quantity: 1,
                        stock: 'æœ‰',
                        selected: true,
                        addedAt: new Date().toISOString()
                    }
                ];
            }

            async saveCartData() {
                try {
                    // ä¿å­˜åˆ°æœ¬åœ°
                    localStorage.setItem('cartItems', JSON.stringify(this.cartItems));
                    
                    // å¦‚æœå·²ç™»å…¥ï¼ŒåŒæ™‚ä¿å­˜åˆ°è³‡æ–™åº«
                    if (this.isLoggedIn && this.currentUser && window.bookstoreDB && window.bookstoreDB.db) {
                        await window.bookstoreDB.saveCart(this.currentUser, this.cartItems);
                        console.log('âœ… è³¼ç‰©è»Šè³‡æ–™å·²åŒæ­¥åˆ°è³‡æ–™åº«');
                    }
                } catch (error) {
                    console.error('âŒ ä¿å­˜è³¼ç‰©è»Šè³‡æ–™å¤±æ•—:', error);
                }
            }

            async addToCart(product) {
                try {
                    const existingItemIndex = this.cartItems.findIndex(item => item.id === product.id);
                    
                    if (existingItemIndex >= 0) {
                        // å•†å“å·²å­˜åœ¨ï¼Œå¢åŠ æ•¸é‡
                        this.cartItems[existingItemIndex].quantity += (product.quantity || 1);
                    } else {
                        // æ–°å•†å“ï¼Œæ·»åŠ åˆ°è³¼ç‰©è»Š
                        this.cartItems.push({
                            id: product.id,
                            title: product.title,
                            price: product.currentPrice || product.price,
                            originalPrice: product.originalPrice,
                            quantity: product.quantity || 1,
                            stock: 'æœ‰',
                            selected: true,
                            addedAt: new Date().toISOString(),
                            note: product.note || 'å„ªæƒ æœŸé™è‡³2025/06/30'
                        });
                    }
                    
                    await this.saveCartData();
                    this.updateCartDisplay();
                    
                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    this.showNotification(`âœ… "${product.title}" å·²åŠ å…¥è³¼ç‰©è»Š`, 'success');
                    
                    console.log('âœ… å•†å“å·²åŠ å…¥è³¼ç‰©è»Š:', product.title);
                } catch (error) {
                    console.error('âŒ åŠ å…¥è³¼ç‰©è»Šå¤±æ•—:', error);
                    this.showNotification('âŒ åŠ å…¥è³¼ç‰©è»Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            }

            async removeItem(index) {
                try {
                    const item = this.cartItems[index];
                    if (confirm(`ç¢ºå®šè¦å¾è³¼ç‰©è»Šä¸­ç§»é™¤ã€Œ${item.title}ã€å—ï¼Ÿ`)) {
                        this.cartItems.splice(index, 1);
                        await this.saveCartData();
                        this.updateCartDisplay();
                        
                        this.showNotification(`ğŸ—‘ï¸ "${item.title}" å·²å¾è³¼ç‰©è»Šç§»é™¤`, 'info');
                    }
                } catch (error) {
                    console.error('âŒ ç§»é™¤å•†å“å¤±æ•—:', error);
                    this.showNotification('âŒ ç§»é™¤å•†å“å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            }

            async updateQuantity(index, change) {
                try {
                    const newQuantity = this.cartItems[index].quantity + change;
                    if (newQuantity >= 1) {
                        this.cartItems[index].quantity = newQuantity;
                        await this.saveCartData();
                        this.updateCartDisplay();
                    }
                } catch (error) {
                    console.error('âŒ æ›´æ–°æ•¸é‡å¤±æ•—:', error);
                }
            }

            async setQuantity(index, quantity) {
                try {
                    const qty = parseInt(quantity);
                    if (qty >= 1) {
                        this.cartItems[index].quantity = qty;
                        await this.saveCartData();
                        this.updateCartDisplay();
                    }
                } catch (error) {
                    console.error('âŒ è¨­ç½®æ•¸é‡å¤±æ•—:', error);
                }
            }

            toggleItemSelection(index) {
                this.cartItems[index].selected = !this.cartItems[index].selected;
                this.updateSummary();
                this.saveCartData();
            }

            toggleSelectAll() {
                const selectAll = document.getElementById('selectAll').checked;
                this.cartItems.forEach(item => item.selected = selectAll);
                this.updateCartDisplay();
            }

            updateCartDisplay() {
                const tableBody = document.getElementById('cartTableBody');
                const emptyCart = document.getElementById('emptyCart');
                const cartTableContainer = document.getElementById('cartTableContainer');
                const cartFooter = document.getElementById('cartFooter');
                
                if (this.cartItems.length === 0) {
                    cartTableContainer.style.display = 'none';
                    cartFooter.style.display = 'none';
                    emptyCart.style.display = 'block';
                    return;
                }
                
                cartTableContainer.style.display = 'block';
                cartFooter.style.display = 'flex';
                emptyCart.style.display = 'none';
                
                tableBody.innerHTML = this.cartItems.map((item, index) => `
                    <tr>
                        <td style="text-align: center;">
                            <input type="checkbox" ${item.selected ? 'checked' : ''} 
                                   onchange="cartManager.toggleItemSelection(${index})">
                        </td>
                        <td>
                            <div style="display: flex; gap: 15px; align-items: center;">
                                <div class="product-image">å°é¢åœ–ç‰‡</div>
                                <div class="product-info">
                                    <div class="product-title">${item.title}</div>
                                    <div class="product-note">${item.note || ''}</div>
                                </div>
                            </div>
                        </td>
                        <td class="price-info">
                            <div class="current-price">$ ${item.price.toLocaleString()}</div>
                            ${item.originalPrice ? `<div class="original-price">$ ${item.originalPrice.toLocaleString()}</div>` : ''}
                        </td>
                        <td>
                            <div class="quantity-control">
                                <button class="qty-btn" onclick="cartManager.updateQuantity(${index}, -1)" ${item.quantity <= 1 ? 'disabled' : ''}>âˆ’</button>
                                <input type="number" class="qty-input" value="${item.quantity}" 
                                       onchange="cartManager.setQuantity(${index}, this.value)" min="1">
                                <button class="qty-btn" onclick="cartManager.updateQuantity(${index}, 1)">+</button>
                            </div>
                        </td>
                        <td class="subtotal">$ ${(item.price * item.quantity).toLocaleString()}</td>
                        <td class="stock-status">${item.stock || 'æœ‰'}</td>
                        <td>
                            <div class="action-buttons">
                                <button class="action-btn" onclick="addToNextTime(${index})">ä¸‹æ¬¡å†è²·</button>
                                <button class="action-btn remove-btn" onclick="cartManager.removeItem(${index})">åˆªé™¤</button>
                            </div>
                        </td>
                    </tr>
                `).join('');
                
                this.updateSummary();
            }

            updateSummary() {
                const selectedItems = this.cartItems.filter(item => item.selected);
                const totalItems = selectedItems.length;
                const totalQuantity = selectedItems.reduce((sum, item) => sum + item.quantity, 0);
                const totalAmount = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);
                
                document.getElementById('totalItems').textContent = totalItems;
                document.getElementById('totalQuantity').textContent = totalQuantity;
                document.getElementById('totalAmount').textContent = totalAmount.toLocaleString();
                
                // æ›´æ–°çµå¸³æŒ‰éˆ•ç‹€æ…‹
                const checkoutBtn = document.getElementById('checkoutBtn');
                if (totalItems === 0) {
                    checkoutBtn.disabled = true;
                    checkoutBtn.textContent = 'è«‹é¸æ“‡å•†å“';
                } else {
                    checkoutBtn.disabled = false;
                    checkoutBtn.textContent = 'åœ‹å…§çµå¸³';
                }
                
                // æ›´æ–°å°èˆªæ¬„ä¸­çš„è³¼ç‰©è»Šæ•¸é‡
                const allQuantity = this.cartItems.reduce((sum, item) => sum + item.quantity, 0);
                const cartCountElements = document.querySelectorAll('#cartCount');
                cartCountElements.forEach(element => {
                    if (element) element.textContent = allQuantity;
                });
            }

            // åŒæ­¥è³¼ç‰©è»Šè³‡æ–™
            async syncCartWithDatabase() {
                if (!this.isLoggedIn) {
                    this.showNotification('âš ï¸ è«‹å…ˆç™»å…¥æœƒå“¡æ‰èƒ½åŒæ­¥è³¼ç‰©è»Š', 'warning');
                    return;
                }

                try {
                    this.showNotification('ğŸ”„ æ­£åœ¨åŒæ­¥è³¼ç‰©è»Šè³‡æ–™...', 'info');
                    
                    await this.loadCartData();
                    this.showNotification('âœ… è³¼ç‰©è»Šè³‡æ–™åŒæ­¥å®Œæˆ', 'success');
                } catch (error) {
                    console.error('âŒ åŒæ­¥è³¼ç‰©è»Šå¤±æ•—:', error);
                    this.showNotification('âŒ åŒæ­¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                }
            }

            // æ¸…ç©ºè³¼ç‰©è»Š
            async clearCart() {
                if (confirm('ç¢ºå®šè¦æ¸…ç©ºæ•´å€‹è³¼ç‰©è»Šå—ï¼Ÿ')) {
                    try {
                        this.cartItems = [];
                        await this.saveCartData();
                        this.updateCartDisplay();
                        this.showNotification('ğŸ—‘ï¸ è³¼ç‰©è»Šå·²æ¸…ç©º', 'info');
                    } catch (error) {
                        console.error('âŒ æ¸…ç©ºè³¼ç‰©è»Šå¤±æ•—:', error);
                        this.showNotification('âŒ æ¸…ç©ºå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
                    }
                }
            }

            // æ·»åŠ æ¸¬è©¦å•†å“
            async addTestProducts() {
                const testProducts = [
                    {
                        id: 'book003',
                        title: 'è²¡å¯Œç†çš„æ™®é€šå¸¸è­˜ (ç´€å¿µå…¸è—ç‰ˆ)',
                        note: '66æŠ˜ç‰¹æƒ ä¸­',
                        price: 330,
                        originalPrice: 500,
                        quantity: 1
                    },
                    {
                        id: 'book004',
                        title: 'æ˜æ™ºæ®ºä»‹çš„å¥”èµ°ã€åšå®¢ä¾†ç‰¹åˆ¥ç‰ˆã€‘',
                        note: '79æŠ˜å„ªæƒ ',
                        price: 363,
                        originalPrice: 460,
                        quantity: 1
                    }
                ];
                
                let addedCount = 0;
                for (const product of testProducts) {
                    const existingItem = this.cartItems.find(item => item.id === product.id);
                    if (!existingItem) {
                        await this.addToCart(product);
                        addedCount++;
                    }
                }
                
                if (addedCount > 0) {
                    this.showNotification(`ğŸ“š å·²æ·»åŠ  ${addedCount} æœ¬æ¸¬è©¦å•†å“åˆ°è³¼ç‰©è»Š`, 'success');
                } else {
                    this.showNotification('é€™äº›æ¸¬è©¦å•†å“å·²ç¶“åœ¨è³¼ç‰©è»Šä¸­äº†ï¼', 'info');
                }
            }

            // çµå¸³è™•ç†
            async proceedToCheckout() {
                const selectedItems = this.cartItems.filter(item => item.selected);
                
                if (selectedItems.length === 0) {
                    this.showNotification('è«‹å…ˆé¸æ“‡è¦çµå¸³çš„å•†å“', 'warning');
                    return;
                }

                if (!this.isLoggedIn) {
                    if (confirm('éœ€è¦ç™»å…¥æœƒå“¡æ‰èƒ½é€²è¡Œçµå¸³ï¼Œæ˜¯å¦å‰å¾€ç™»å…¥ï¼Ÿ')) {
                        window.location.href = 'login.html?redirect=shopping.html';
                    }
                    return;
                }

                this.openCheckoutModal();
            }

            openCheckoutModal() {
                const selectedItems = this.cartItems.filter(item => item.selected);
                const totalAmount = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                // æ›´æ–°è¨‚å–®æ‘˜è¦
                const summaryContainer = document.getElementById('orderSummaryItems');
                summaryContainer.innerHTML = selectedItems.map(item => `
                    <div class="order-item">
                        <span>${item.title} x${item.quantity}</span>
                        <span>$ ${(item.price * item.quantity).toLocaleString()}</span>
                    </div>
                `).join('');

                document.getElementById('orderTotalAmount').textContent = totalAmount.toLocaleString();

                // é å¡«ç”¨æˆ¶è³‡æ–™
                if (this.currentUser) {
                    const userName = localStorage.getItem('userName');
                    if (userName) {
                        document.getElementById('shippingName').value = userName;
                    }
                }

                document.getElementById('checkoutModal').classList.add('show');
            }

            closeCheckoutModal() {
                document.getElementById('checkoutModal').classList.remove('show');
                document.getElementById('checkoutForm').reset();
            }

            async submitOrder(event) {
                event.preventDefault();

                const selectedItems = this.cartItems.filter(item => item.selected);
                const totalAmount = selectedItems.reduce((sum, item) => sum + (item.price * item.quantity), 0);

                const orderData = {
                    userEmail: this.currentUser,
                    items: selectedItems,
                    totalAmount: totalAmount,
                    paymentMethod: document.getElementById('paymentMethod').value,
                    shippingAddress: `${document.getElementById('shippingName').value}, ${document.getElementById('shippingPhone').value}, ${document.getElementById('shippingAddress').value}`,
                    notes: 'ä¾†è‡ªç·šä¸Šè³¼ç‰©è»Š'
                };

                const submitBtn = document.getElementById('submitOrderBtn');
                submitBtn.disabled = true;
                submitBtn.textContent = 'â³ è™•ç†ä¸­...';

                try {
                    console.log('ğŸ›’ é–‹å§‹å‰µå»ºè¨‚å–®:', orderData);

                    // æª¢æŸ¥è³‡æ–™åº«æ˜¯å¦æº–å‚™å°±ç·’
                    if (!window.bookstoreDB || !window.bookstoreDB.db) {
                        throw new Error('è³‡æ–™åº«å°šæœªæº–å‚™å°±ç·’ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }

                    // å‰µå»ºè¨‚å–®
                    const newOrder = await window.bookstoreDB.createOrder(orderData);
                    
                    console.log('âœ… è¨‚å–®å‰µå»ºæˆåŠŸ:', newOrder);

                    // å¾è³¼ç‰©è»Šç§»é™¤å·²çµå¸³çš„å•†å“
                    this.cartItems = this.cartItems.filter(item => !item.selected);
                    await this.saveCartData();
                    this.updateCartDisplay();

                    // é—œé–‰çµå¸³è¦–çª—
                    this.closeCheckoutModal();

                    // é¡¯ç¤ºæˆåŠŸè¨Šæ¯
                    alert(`ğŸ‰ è¨‚å–®å‰µå»ºæˆåŠŸï¼\n\nè¨‚å–®ç·¨è™Ÿï¼š${newOrder.orderNumber}\nç¸½é‡‘é¡ï¼šNT$ ${totalAmount.toLocaleString()}\n\næ‚¨å¯ä»¥åœ¨ã€Œè¨‚å–®æŸ¥è©¢ã€ä¸­æŸ¥çœ‹è¨‚å–®è©³æƒ…ã€‚`);

                    // è·³è½‰åˆ°è¨‚å–®æŸ¥è©¢é é¢
                    if (confirm('æ˜¯å¦å‰å¾€è¨‚å–®æŸ¥è©¢é é¢æŸ¥çœ‹è©³æƒ…ï¼Ÿ')) {
                        window.location.href = 'ordersearch.html';
                    }

                } catch (error) {
                    console.error('âŒ å‰µå»ºè¨‚å–®å¤±æ•—:', error);
                    alert(error.message || 'å‰µå»ºè¨‚å–®å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                } finally {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'ğŸ’³ ç¢ºèªä¸‹å–®';
                }
            }

            showNotification(message, type = 'info') {
                const colors = {
                    success: '#4CAF50',
                    info: '#2196F3',
                    warning: '#ff9800',
                    error: '#f44336'
                };
                
                const notification = document.createElement('div');
                notification.style.cssText = `
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${colors[type]};
                    color: white;
                    padding: 15px 20px;
                    border-radius: 5px;
                    z-index: 1000;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    max-width: 300px;
                    font-size: 14px;
                    opacity: 0;
                    transform: translateX(100%);
                    transition: all 0.3s ease;
                `;
                notification.textContent = message;
                
                document.body.appendChild(notification);
                
                // å‹•ç•«é€²å…¥
                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 10);
                
                // è‡ªå‹•æ¶ˆå¤±
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.remove();
                        }
                    }, 300);
                }, 3000);
            }
        }

        // å‰µå»ºå…¨åŸŸè³¼ç‰©è»Šç®¡ç†å™¨å¯¦ä¾‹
        let cartManager;

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('ğŸ›’ è³¼ç‰©è»Šé é¢è¼‰å…¥å®Œæˆ');
            
            // ç­‰å¾…è³‡æ–™åº«æº–å‚™å°±ç·’å¾Œåˆå§‹åŒ–
            const initCartManager = () => {
                if (window.bookstoreDB) {
                    cartManager = new EnhancedCartManager();
                } else {
                    setTimeout(initCartManager, 100);
                }
            };
            
            initCartManager();
        });

        // å…¨åŸŸå‡½æ•¸ï¼ˆä¾›HTMLèª¿ç”¨ï¼‰
        function handleLoginLogout() {
            if (cartManager && cartManager.isLoggedIn) {
                logout();
            } else {
                window.location.href = 'login.html?redirect=shopping.html';
            }
        }

        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('userName');
                localStorage.removeItem('userId');
                localStorage.removeItem('loginTime');
                
                cartManager.showNotification('âœ… å·²æˆåŠŸç™»å‡º', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 1500);
            }
        }

        function addTestProducts() {
            if (cartManager) {
                cartManager.addTestProducts();
            }
        }

        function syncCartWithDatabase() {
            if (cartManager) {
                cartManager.syncCartWithDatabase();
            }
        }

        function clearCart() {
            if (cartManager) {
                cartManager.clearCart();
            }
        }

        function proceedToCheckout() {
            if (cartManager) {
                cartManager.proceedToCheckout();
            }
        }

        function closeCheckoutModal() {
            if (cartManager) {
                cartManager.closeCheckoutModal();
            }
        }

        function submitOrder(event) {
            if (cartManager) {
                cartManager.submitOrder(event);
            }
        }

        function addToNextTime(index) {
            if (cartManager) {
                const item = cartManager.cartItems[index];
                alert(`"${item.title}" å·²åŠ å…¥ä¸‹æ¬¡å†è²·æ¸…å–®`);
                cartManager.removeItem(index);
            }
        }

        function addSelectedToNextTime() {
            if (cartManager) {
                const selectedCount = cartManager.cartItems.filter(item => item.selected).length;
                if (selectedCount === 0) {
                    alert('è«‹å…ˆé¸æ“‡è¦æ“ä½œçš„å•†å“');
                    return;
                }
                
                if (confirm(`ç¢ºå®šè¦å°‡ ${selectedCount} é …å•†å“åŠ å…¥ä¸‹æ¬¡å†è²·æ¸…å–®å—ï¼Ÿ`)) {
                    cartManager.cartItems = cartManager.cartItems.filter(item => !item.selected);
                    cartManager.saveCartData();
                    cartManager.updateCartDisplay();
                    cartManager.showNotification('å·²å°‡é¸ä¸­çš„å•†å“åŠ å…¥ä¸‹æ¬¡å†è²·æ¸…å–®', 'success');
                }
            }
        }

        function removeSelected() {
            if (cartManager) {
                const selectedCount = cartManager.cartItems.filter(item => item.selected).length;
                if (selectedCount === 0) {
                    alert('è«‹å…ˆé¸æ“‡è¦åˆªé™¤çš„å•†å“');
                    return;
                }
                
                if (confirm(`ç¢ºå®šè¦åˆªé™¤ ${selectedCount} é …å•†å“å—ï¼Ÿ`)) {
                    cartManager.cartItems = cartManager.cartItems.filter(item => !item.selected);
                    cartManager.saveCartData();
                    cartManager.updateCartDisplay();
                    cartManager.showNotification('å·²åˆªé™¤é¸ä¸­çš„å•†å“', 'success');
                }
            }
        }

        function toggleSelectAll() {
            if (cartManager) {
                cartManager.toggleSelectAll();
            }
        }

        function continueShopping() {
            window.location.href = 'index.html';
        }

        function goToOverseas() {
            alert('æµ·å¤–çµå¸³åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function togglePromoDetail() {
            const detail = document.getElementById('promoDetail');
            if (detail.style.display === 'none') {
                detail.style.display = 'block';
            } else {
                detail.style.display = 'none';
            }
        }

        function switchTab(tabType, element) {
            // æ›´æ–°æ¨™ç±¤ç‹€æ…‹
            document.querySelectorAll('.cart-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            element.classList.add('active');
            
            // æ ¹æ“šä¸åŒæ¨™ç±¤é¡¯ç¤ºä¸åŒå…§å®¹
            switch(tabType) {
                case 'purchase':
                    if (cartManager) {
                        cartManager.updateCartDisplay();
                    }
                    break;
                case 'free':
                    showFreeGifts();
                    break;
                case 'points':
                    showPointsReward();
                    break;
                case 'next':
                    showNextTimeBuy();
                    break;
                case 'notice':
                    showNoticeItems();
                    break;
            }
        }

        function showFreeGifts() {
            document.getElementById('cartTableContainer').style.display = 'none';
            document.getElementById('cartFooter').style.display = 'none';
            document.getElementById('emptyCart').innerHTML = `
                <h3>ğŸ å…è²»è´ˆå“</h3>
                <p>ç›®å‰æ²’æœ‰ç¬¦åˆè´ˆå“æ¢ä»¶çš„å•†å“</p>
                <a href="index.html" class="shop-now-btn">ç¹¼çºŒè³¼ç‰©</a>
            `;
            document.getElementById('emptyCart').style.display = 'block';
        }

        function showPointsReward() {
            document.getElementById('cartTableContainer').style.display = 'none';
            document.getElementById('cartFooter').style.display = 'none';
            document.getElementById('emptyCart').innerHTML = `
                <h3>ğŸ¯ é»æ•¸å›é¥‹</h3>
                <p>è³¼è²·å•†å“å³å¯ç²å¾—é»æ•¸å›é¥‹</p>
                <a href="index.html" class="shop-now-btn">æŸ¥çœ‹å›é¥‹èªªæ˜</a>
            `;
            document.getElementById('emptyCart').style.display = 'block';
        }

        function showNextTimeBuy() {
            document.getElementById('cartTableContainer').style.display = 'none';
            document.getElementById('cartFooter').style.display = 'none';
            document.getElementById('emptyCart').innerHTML = `
                <h3>ğŸ“ ä¸‹æ¬¡å†è²·æ¸…å–®</h3>
                <p>æ‚¨çš„ä¸‹æ¬¡å†è²·æ¸…å–®æ˜¯ç©ºçš„</p>
                <a href="index.html" class="shop-now-btn">ç¹¼çºŒè³¼ç‰©</a>
            `;
            document.getElementById('emptyCart').style.display = 'block';
        }

        function showNoticeItems() {
            document.getElementById('cartTableContainer').style.display = 'none';
            document.getElementById('cartFooter').style.display = 'none';
            document.getElementById('emptyCart').innerHTML = `
                <h3>âš ï¸ æ³¨æ„äº‹é …</h3>
                <p>è«‹è©³é–±è³¼ç‰©é ˆçŸ¥å’Œé…é€èªªæ˜</p>
                <a href="#" class="shop-now-btn" onclick="showShippingInfo()">æŸ¥çœ‹è©³ç´°èªªæ˜</a>
            `;
            document.getElementById('emptyCart').style.display = 'block';
        }

        // å…¶ä»–åŠŸèƒ½
        function showOrders() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html?redirect=ordersearch.html';
                return;
            }
            window.location.href = 'ordersearch.html';
        }

        function showNewReleases() {
            alert('æ–°æ›¸æ¨è–¦é é¢é–‹ç™¼ä¸­...');
        }

        function showBestsellers() {
            alert('æš¢éŠ·æ¦œé é¢é–‹ç™¼ä¸­...');
        }

        function showEbooks() {
            alert('é›»å­æ›¸åŸé é¢é–‹ç™¼ä¸­...');
        }

        function toggleLanguage() {
            alert('èªè¨€åˆ‡æ›åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        function showShippingInfo() {
            alert('é…é€è³‡è¨Šèªªæ˜é–‹ç™¼ä¸­...');
        }

        function showOverseasInfo() {
            alert('æµ·å¤–é…é€èªªæ˜é–‹ç™¼ä¸­...');
        }

        function showShippingCost() {
            alert('é‹è²»èªªæ˜é–‹ç™¼ä¸­...');
        }

        // é»æ“Šå½ˆå‡ºè¦–çª—å¤–éƒ¨é—œé–‰
        document.getElementById('checkoutModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCheckoutModal();
            }
        });

        // å…¨åŸŸè³¼ç‰©è»Šæ·»åŠ å‡½æ•¸ï¼ˆä¾›å…¶ä»–é é¢èª¿ç”¨ï¼‰
        window.addToCart = function(product) {
            if (cartManager) {
                cartManager.addToCart(product);
            } else {
                console.warn('è³¼ç‰©è»Šç®¡ç†å™¨å°šæœªåˆå§‹åŒ–');
            }
        };

        console.log('ğŸ“¦ å¢å¼·ç‰ˆè³¼ç‰©è»Šè…³æœ¬è¼‰å…¥å®Œæˆ');
    </script>
</body>
</html>