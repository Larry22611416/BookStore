<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">å•†å“è©³æƒ… - æ›¸å®¢ä¾†ç·šä¸Šæ›¸åº—</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "å¾®è»Ÿé›…é»‘", Arial, sans-serif;
            background-color: #f5f5f5;
        }

        /* é ‚éƒ¨å°èˆª */
        .top-nav {
            background-color: #fff;
            border-bottom: 1px solid #e0e0e0;
            padding: 8px 0;
        }

        .top-nav .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            font-size: 13px;
        }

        .nav-left a, .nav-right a {
            color: #666;
            text-decoration: none;
            margin: 0 10px;
        }

        .nav-left a:hover, .nav-right a:hover {
            color: #4CAF50;
        }

        /* æœå°‹å€åŸŸ */
        .search-section {
            background-color: #fff;
            padding: 15px 0;
            border-bottom: 2px solid #4CAF50;
        }

        .search-container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 0 20px;
        }

        .logo {
            margin-right: 30px;
        }

        .logo h1 {
            color: #4CAF50;
            font-size: 24px;
            font-weight: bold;
            text-decoration: none;
        }

        .search-box {
            flex: 1;
            display: flex;
            max-width: 500px;
        }

        .category-select {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            border-right: none;
            padding: 8px 12px;
            font-size: 14px;
            border-radius: 4px 0 0 4px;
            outline: none;
        }

        .search-input {
            flex: 1;
            border: 1px solid #ddd;
            border-left: none;
            border-right: none;
            padding: 8px 12px;
            font-size: 14px;
            outline: none;
        }

        .search-btn {
            background-color: #4CAF50;
            color: white;
            border: 1px solid #4CAF50;
            padding: 8px 15px;
            font-size: 14px;
            border-radius: 0 4px 4px 0;
            cursor: pointer;
        }

        /* åˆ†é¡å°èˆª */
        .category-nav {
            background-color: #4CAF50;
            padding: 10px 0;
        }

        .category-nav .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .category-links {
            display: flex;
            gap: 30px;
            align-items: center;
        }

        .category-links a {
            color: white;
            text-decoration: none;
            font-size: 14px;
            padding: 5px 0;
        }

        .category-links a:hover {
            text-decoration: underline;
        }

        /* éºµåŒ…å±‘å°èˆª */
        .breadcrumb {
            background-color: #fff;
            padding: 15px 0;
            border-bottom: 1px solid #e0e0e0;
        }

        .breadcrumb .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            font-size: 13px;
            color: #666;
            display: flex;
            align-items: center;
        }

        .breadcrumb a {
            color: #4CAF50;
            text-decoration: none;
        }

        .breadcrumb a:hover {
            text-decoration: underline;
        }

        /* ä¸»è¦å…§å®¹å€åŸŸ */
        .main-container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
            display: flex;
            gap: 20px;
        }

        /* å•†å“è©³æƒ…ä¸»é«” */
        .product-detail {
            flex: 1;
            background-color: #fff;
            border-radius: 4px;
            padding: 30px;
        }

        .product-main {
            display: flex;
            gap: 40px;
            margin-bottom: 40px;
        }

        /* å•†å“åœ–ç‰‡ */
        .product-image-section {
            flex-shrink: 0;
        }

        .product-image {
            width: 280px;
            height: 400px;
            background-color: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 14px;
            border: 1px solid #e0e0e0;
            position: relative;
            overflow: hidden;
        }

        .product-image img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* å•†å“è³‡è¨Š */
        .product-info {
            flex: 1;
        }

        .product-title {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
            line-height: 1.4;
        }

        .product-subtitle {
            font-size: 16px;
            color: #666;
            margin-bottom: 20px;
        }

        .product-meta {
            margin-bottom: 25px;
        }

        .meta-row {
            display: flex;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .meta-label {
            width: 80px;
            color: #666;
            flex-shrink: 0;
        }

        .meta-value {
            color: #333;
        }

        .meta-value a {
            color: #4CAF50;
            text-decoration: none;
        }

        .meta-value a:hover {
            text-decoration: underline;
        }

        /* åƒ¹æ ¼å€åŸŸ */
        .price-section {
            background-color: #f8f8f8;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }

        .price-main {
            display: flex;
            align-items: baseline;
            gap: 15px;
            margin-bottom: 10px;
        }

        .current-price {
            font-size: 28px;
            font-weight: bold;
            color: #e74c3c;
        }

        .original-price {
            font-size: 18px;
            color: #999;
            text-decoration: line-through;
        }

        .discount-rate {
            background-color: #e74c3c;
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }

        .price-note {
            font-size: 13px;
            color: #666;
            margin-bottom: 15px;
        }

        /* å„ªæƒ æ¨™ç±¤ */
        .promotion-tags {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .promo-tag {
            background-color: #4CAF50;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 12px;
            display: inline-block;
            width: fit-content;
        }

        .promo-tag.blue {
            background-color: #2196F3;
        }

        /* è³¼è²·å€åŸŸ */
        .purchase-section {
            border: 2px solid #4CAF50;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .stock-info {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stock-status {
            font-weight: bold;
            color: #4CAF50;
        }

        .stock-count {
            color: #666;
            font-size: 14px;
        }

        .purchase-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            text-decoration: none;
            display: block;
        }

        .btn-primary {
            background-color: #ffc107;
            color: #333;
        }

        .btn-primary:hover {
            background-color: #ffb300;
        }

        .btn-secondary {
            background-color: #ff6b35;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #e55a2b;
        }

        .btn-outline {
            background-color: white;
            border: 2px solid #ddd;
            color: #666;
        }

        .btn-outline:hover {
            border-color: #4CAF50;
            color: #4CAF50;
        }

        /* é…é€è³‡è¨Š */
        .shipping-info {
            font-size: 13px;
            color: #666;
            margin-top: 15px;
        }

        .shipping-info p {
            margin-bottom: 5px;
        }

        /* å³å´é‚Šæ¬„ */
        .sidebar {
            width: 300px;
            flex-shrink: 0;
        }

        .sidebar-section {
            background-color: #fff;
            border-radius: 4px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 16px;
            font-weight: bold;
            color: #333;
            margin-bottom: 15px;
            border-bottom: 2px solid #4CAF50;
            padding-bottom: 5px;
        }

        /* åˆ†äº«å€åŸŸ */
        .share-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .share-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: transform 0.3s;
        }

        .share-btn:hover {
            transform: scale(1.1);
        }

        .share-btn.facebook {
            background-color: #3b5998;
            color: white;
        }

        .share-btn.line {
            background-color: #00c300;
            color: white;
        }

        .share-btn.copy {
            background-color: #666;
            color: white;
        }

        /* å…§å®¹å€åŸŸ */
        .content-sections {
            margin-top: 40px;
        }

        .content-tab-nav {
            display: flex;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }

        .content-tab {
            padding: 15px 25px;
            background-color: #f8f8f8;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
            border-top-left-radius: 8px;
            border-top-right-radius: 8px;
        }

        .content-tab.active {
            background-color: #4CAF50;
            color: white;
        }

        .content-tab:hover:not(.active) {
            background-color: #e0e0e0;
        }

        .content-panel {
            display: none;
            line-height: 1.8;
            color: #333;
        }

        .content-panel.active {
            display: block;
        }

        .content-panel h3 {
            color: #4CAF50;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .content-panel p {
            margin-bottom: 15px;
            text-align: justify;
        }

        /* ä½œè€…è³‡è¨Š */
        .author-info {
            background-color: #f9f9f9;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .author-name {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }

        /* è©³ç´°è³‡æ–™è¡¨æ ¼ */
        .detail-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        .detail-table th,
        .detail-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
        }

        .detail-table th {
            background-color: #f8f8f8;
            font-weight: bold;
            width: 120px;
        }

        /* è©•åƒ¹å€åŸŸ */
        .rating-summary {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background-color: #f9f9f9;
            border-radius: 8px;
        }

        .rating-score {
            font-size: 48px;
            font-weight: bold;
            color: #4CAF50;
        }

        .rating-stars {
            font-size: 24px;
            color: #ffc107;
            margin-bottom: 5px;
        }

        .rating-info {
            color: #666;
            font-size: 14px;
        }

        .rating-actions {
            margin-left: auto;
        }

        .rating-btn {
            background-color: #ffc107;
            color: #333;
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
        }

        /* å€‹åˆ¥è©•åƒ¹ */
        .review-item {
            border-bottom: 1px solid #e0e0e0;
            padding: 20px 0;
        }

        .review-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 10px;
        }

        .reviewer-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #4CAF50;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .reviewer-info {
            flex: 1;
        }

        .reviewer-name {
            font-weight: bold;
            color: #333;
        }

        .review-date {
            font-size: 12px;
            color: #999;
        }

        .review-rating {
            color: #ffc107;
            font-size: 16px;
        }

        .review-content {
            margin-left: 55px;
            color: #333;
            line-height: 1.6;
        }

        .review-title {
            font-weight: bold;
            margin-bottom: 10px;
        }

        .review-helpful {
            margin-left: 55px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .helpful-btn {
            background-color: #f8f8f8;
            border: 1px solid #ddd;
            padding: 5px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .helpful-btn:hover {
            background-color: #4CAF50;
            color: white;
            border-color: #4CAF50;
        }

        /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                padding: 0 10px;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .product-main {
                flex-direction: column;
                gap: 20px;
            }
            
            .product-image {
                width: 100%;
                max-width: 300px;
                margin: 0 auto;
            }
            
            .search-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-box {
                max-width: 100%;
            }
            
            .category-links {
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .content-tab-nav {
                flex-wrap: wrap;
            }
            
            .content-tab {
                flex: 1;
                min-width: 120px;
            }
        }
    </style>
</head>
<body>
    <!-- é ‚éƒ¨å°èˆª -->
    <div class="top-nav">
        <div class="container">
            <div class="nav-left">
                <a href="index.html">å›é¦–é </a>
                <a href="#" onclick="showNewReleases()">æ–°æ›¸æ¨è–¦</a>
                <a href="#" onclick="showBestsellers()">æš¢éŠ·æ¦œ</a>
                <a href="#" onclick="showEbooks()">é›»å­æ›¸åŸ</a>
            </div>
            <div class="nav-right">
                <span id="userInfo">æœªç™»å…¥</span>
                <a href="#" id="loginLogoutBtn" onclick="handleLoginLogout()">æœƒå“¡ç™»å…¥</a>
                <a href="#" onclick="showOrders()">è¨‚å–®æŸ¥è©¢</a>
                <a href="shopping.html">è³¼ç‰©è»Š(<span id="cartCount">0</span>)</a>
                <a href="#" onclick="toggleLanguage()">ç¹é«”</a>
            </div>
        </div>
    </div>

    <!-- æœå°‹å€åŸŸ -->
    <div class="search-section">
        <div class="search-container">
            <div class="logo">
                <a href="index.html" style="text-decoration: none;">
                    <h1>æ›¸å®¢ä¾†</h1>
                </a>
            </div>
            <div class="search-box">
                <select class="category-select" id="searchCategory">
                    <option value="all">å…¨éƒ¨</option>
                    <option value="chinese">ä¸­æ–‡æ›¸</option>
                    <option value="english">å¤–æ–‡æ›¸</option>
                    <option value="ebook">é›»å­æ›¸</option>
                </select>
                <input type="text" class="search-input" placeholder="è«‹è¼¸å…¥æ›¸åæˆ–ä½œè€…" id="searchInput">
                <button class="search-btn" onclick="performSearch()">ğŸ”</button>
            </div>
        </div>
    </div>

    <!-- åˆ†é¡å°èˆª -->
    <div class="category-nav">
        <div class="container">
            <div class="category-links">
                <a href="#">å…¨ç«™åˆ†é¡</a>
                <a href="#">ä¸­æ–‡æ›¸ç±</a>
                <a href="#">å¤–æ–‡æ›¸ç±</a>
                <a href="#">é›»å­æ›¸</a>
                <a href="#">ç«¥æ›¸é¤¨</a>
                <a href="#">æ–‡å­¸å°èªª</a>
                <a href="#">å•†æ¥­ç†è²¡</a>
                <a href="#">å¿ƒç†å‹µå¿—</a>
            </div>
        </div>
    </div>

    <!-- éºµåŒ…å±‘å°èˆª -->
    <div class="breadcrumb">
        <div class="container">
            <span id="breadcrumbPath">
                <a href="index.html">æ›¸å®¢ä¾†</a> > 
                <a href="#">ä¸­æ–‡æ›¸</a> > 
                <a href="#">æ–‡å­¸å°èªª</a> > 
                <span>å•†å“ä»‹ç´¹</span>
            </span>
        </div>
    </div>

    <!-- ä¸»è¦å…§å®¹ -->
    <div class="main-container">
        <!-- å•†å“è©³æƒ…ä¸»é«” -->
        <div class="product-detail">
            <div class="product-main">
                <!-- å•†å“åœ–ç‰‡ -->
                <div class="product-image-section">
                    <div class="product-image" id="productImage">
                        <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 14px;">è¼‰å…¥ä¸­...</div>
                    </div>
                </div>

                <!-- å•†å“è³‡è¨Š -->
                <div class="product-info">
                    <h1 class="product-title" id="productTitle">è¼‰å…¥ä¸­...</h1>
                    <p class="product-subtitle" id="productSubtitle"></p>

                    <div class="product-meta">
                        <div class="meta-row">
                            <span class="meta-label">ä½œè€…ï¼š</span>
                            <span class="meta-value" id="productAuthor">
                                <a href="#">è¼‰å…¥ä¸­...</a>
                            </span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">åŸæ–‡ä½œè€…ï¼š</span>
                            <span class="meta-value" id="originalAuthor"></span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">è­¯è€…ï¼š</span>
                            <span class="meta-value" id="translator"></span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">å‡ºç‰ˆç¤¾ï¼š</span>
                            <span class="meta-value" id="publisher"></span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">å‡ºç‰ˆæ—¥æœŸï¼š</span>
                            <span class="meta-value" id="publishDate"></span>
                        </div>
                        <div class="meta-row">
                            <span class="meta-label">èªè¨€ï¼š</span>
                            <span class="meta-value" id="language">ç¹é«”ä¸­æ–‡</span>
                        </div>
                    </div>

                    <!-- åƒ¹æ ¼å€åŸŸ -->
                    <div class="price-section">
                        <div class="price-main">
                            <span class="current-price" id="currentPrice">è¼‰å…¥ä¸­...</span>
                            <span class="original-price" id="originalPrice"></span>
                        </div>
                        <p class="price-note" id="priceNote">è¼‰å…¥ä¸­...</p>
                        
                        <div class="promotion-tags">
                            <span class="promo-tag">æœƒå“¡å„ªæƒ åƒ¹</span>
                            <span class="promo-tag blue">æ–°æ›¸ä¸Šå¸‚</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- è³¼è²·å€åŸŸ -->
            <div class="purchase-section">
                <div class="stock-info">
                    <span class="stock-status" id="stockStatus">åº«å­˜å……è¶³</span>
                </div>
                
                <div class="purchase-buttons">
                    <button class="btn btn-primary" onclick="addToCart()">ğŸ›’ æ”¾å…¥è³¼ç‰©è»Š</button>
                    <button class="btn btn-secondary" onclick="buyNow()">ç«‹å³è³¼è²·</button>
                    <button class="btn btn-outline" onclick="addToWishlist()">åŠ å…¥ä¸‹æ¬¡å†è²·æ¸…å–®</button>
                </div>

                <div class="shipping-info">
                    <p>ğŸšš å¯é…é€é»ï¼šå°ç£ã€è˜­å¶¼ã€ç¶ å³¶ã€æ¾æ¹–ã€é‡‘é–€ã€é¦¬ç¥–</p>
                    <p>ğŸ“ å¯å–è²¨é»ï¼šå°ç£ã€è˜­å¶¼ã€ç¶ å³¶ã€æ¾æ¹–ã€é‡‘é–€ã€é¦¬ç¥–</p>
                </div>
            </div>

            <!-- å…§å®¹å€åŸŸ -->
            <div class="content-sections">
                <div class="content-tab-nav">
                    <button class="content-tab active" onclick="showContentTab('description', this)">å…§å®¹ç°¡ä»‹</button>
                    <button class="content-tab" onclick="showContentTab('author', this)">ä½œè€…ä»‹ç´¹</button>
                    <button class="content-tab" onclick="showContentTab('details', this)">è©³ç´°è³‡æ–™</button>
                    <button class="content-tab" onclick="showContentTab('reviews', this)">æœƒå“¡è©•åƒ¹</button>
                </div>

                <!-- å…§å®¹ç°¡ä»‹ -->
                <div class="content-panel active" id="description">
                    <div id="bookDescription">
                        <p>è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <!-- ä½œè€…ä»‹ç´¹ -->
                <div class="content-panel" id="author">
                    <div class="author-info">
                        <div class="author-name" id="authorName">ä½œè€…ä»‹ç´¹</div>
                        <p id="authorIntroduction">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>

                <!-- è©³ç´°è³‡æ–™ -->
                <div class="content-panel" id="details">
                    <table class="detail-table">
                        <tr>
                            <th>ISBN</th>
                            <td id="isbn">è¼‰å…¥ä¸­...</td>
                        </tr>
                        <tr>
                            <th>å¢æ›¸ç³»åˆ—</th>
                            <td id="series">è¼‰å…¥ä¸­...</td>
                        </tr>
                        <tr>
                            <th>è¦æ ¼</th>
                            <td id="specs">è¼‰å…¥ä¸­...</td>
                        </tr>
                        <tr>
                            <th>å‡ºç‰ˆåœ°</th>
                            <td id="origin">å°ç£</td>
                        </tr>
                        <tr>
                            <th>åˆ†é¡</th>
                            <td id="categories">è¼‰å…¥ä¸­...</td>
                        </tr>
                        <tr>
                            <th>å…¶ä»–åˆ†é¡</th>
                            <td id="otherCategories">è¼‰å…¥ä¸­...</td>
                        </tr>
                    </table>
                </div>

                <!-- æœƒå“¡è©•åƒ¹ -->
                <div class="content-panel" id="reviews">
                    <div class="rating-summary">
                        <div class="rating-score" id="averageRating">5</div>
                        <div>
                            <div class="rating-stars" id="ratingStars">â˜…â˜…â˜…â˜…â˜…</div>
                            <div class="rating-info">
                                <span id="totalReviews">5äººè©•åˆ†</span> | 
                                <span id="totalRatings">5å‰‡æ›¸è©•</span> | 
                                <a href="#" style="color: #4CAF50;">çœ‹æœ¬æ›¸æ‰€æœ‰è©•åƒ¹</a>
                            </div>
                        </div>
                        <div class="rating-actions">
                            <button class="rating-btn" onclick="writeReview()">ç™¼è¡¨è©•åƒ¹</button>
                        </div>
                    </div>

                    <div id="reviewsList">
                        <!-- è©•åƒ¹é …ç›®å°‡é€šé JavaScript è¼‰å…¥ -->
                    </div>
                </div>
            </div>
        </div>

        <!-- å³å´é‚Šæ¬„ -->
        <div class="sidebar">
            <!-- åˆ†äº«å€åŸŸ -->
            <div class="sidebar-section">
                <div class="sidebar-title">åˆ†äº«</div>
                <div class="share-buttons">
                    <button class="share-btn facebook" onclick="shareToFacebook()" title="åˆ†äº«åˆ° Facebook">ğŸ“˜</button>
                    <button class="share-btn line" onclick="shareToLine()" title="åˆ†äº«åˆ° LINE">ğŸ’¬</button>
                    <button class="share-btn copy" onclick="copyLink()" title="è¤‡è£½é€£çµ">ğŸ”—</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Google Books API -->
    <script src="js/google-books.js"></script>
    <script>
        // é è¨­å•†å“è³‡æ–™
        let currentProduct = {
            id: 'book001',
            title: 'å“ˆåˆ©æ³¢ç‰¹(3)ï¼šé˜¿èŒ²å¡ç­çš„é€ƒçŠ¯ã€ç¹é«”ä¸­æ–‡ç‰ˆ20é€±å¹´ç´€å¿µã€‘',
            subtitle: 'Harry Potter and The Prisoner of Azkaban',
            author: 'J.K.ç¾…ç³',
            originalAuthor: 'J.K. Rowling',
            translator: 'å½­å€©æ–‡',
            publisher: 'çš‡å† ',
            publishDate: '2020/11/16',
            language: 'ç¹é«”ä¸­æ–‡',
            originalPrice: 520,
            currentPrice: 410,
            discountRate: '79æŠ˜',
            discountNote: 'å„ªæƒ æœŸé™ï¼š2025å¹´06æœˆ30æ—¥æ­¢',
            stock: 10,
            isbn: '9789573336099',
            series: 'CHOICEç³»åˆ—',
            specs: 'å¹³è£ / 512é  / 14.8 x 21 x 2.56 cm / æ™®é€šç´š / å–®è‰²å°åˆ· / åˆç‰ˆ',
            origin: 'å°ç£',
            categories: ['æ–‡å­¸å°èªª', 'ç§‘å¹»/å¥‡å¹»å°èªª', 'æ­ç¾ç§‘å¹»/å¥‡å¹»å°èªª'],
            otherCategories: 'ç«¥æ›¸/é’å°‘å¹´æ–‡å­¸ > æ•…äº‹/å°èªª > ç§‘å¹»/å¥‡å¹»',
            rating: 5,
            reviewCount: 5,
            description: 'ä½›åœ°é­”çš„åƒ•äººå·²è¢«æŸç¸›äº†åäºŒå¹´ä¹‹ä¹…ï¼Œä»Šæ™šåˆå¤œä»¥å‰ï¼Œä»–å°‡å¹«åŠ©ä½›åœ°é­”æ±å±±å†èµ·......'
        };

        // è©•åƒ¹è³‡æ–™
        const reviews = [
            {
                id: 1,
                reviewer: 'æ›¸èŸ²è®€è€…',
                level: 'Lv.3',
                date: '2024/02/18',
                rating: 5,
                title: 'å¾ˆæ£’çš„æ›¸',
                content: 'é€™æ˜¯ä¸€æœ¬å¾ˆç²¾å½©çš„æ›¸ï¼Œå€¼å¾—æ¨è–¦çµ¦å¤§å®¶ï¼',
                helpful: 0
            },
            {
                id: 2,
                reviewer: 'æ„›æ›¸äºº',
                level: 'Lv.2',
                date: '2024/01/17',
                rating: 4,
                title: 'ä¸éŒ¯çš„é¸æ“‡',
                content: 'å…§å®¹è±å¯Œï¼Œä½œè€…çš„ç­†æ³•å¾ˆå¸å¼•äººï¼Œæ¨è–¦é–±è®€ã€‚',
                helpful: 0
            }
        ];

        // ä¿®å¾©ç‰ˆå•†å“è©³æƒ…é é¢è¼‰å…¥é‚è¼¯
        // æ›¿æ› product.html ä¸­çš„ç›¸é—œ JavaScript ä»£ç¢¼

        // è¼‰å…¥å•†å“è³‡æ–™ - ä¿®å¾©ç‰ˆæœ¬
        async function loadProductData(productId) {
            console.log('é–‹å§‹è¼‰å…¥å•†å“è³‡æ–™:', productId);
            
            try {
                // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
                showLoadingState(true);
                
                let product = null;
                let loadMethod = '';

                // æ–¹æ³•1: å„ªå…ˆå¾æœå°‹çµæœä¸­å°‹æ‰¾
                console.log('å˜—è©¦å¾æœå°‹çµæœè¼‰å…¥...');
                const searchResults = getSearchResultsFromSession();
                if (searchResults && searchResults.length > 0 && productId && productId !== 'book001') {
                    product = searchResults.find(book => book.id === productId);
                    if (product) {
                        loadMethod = 'æœå°‹çµæœ';
                        console.log('âœ… å¾æœå°‹çµæœè¼‰å…¥æˆåŠŸ:', product.title);
                    }
                }

                // æ–¹æ³•2: å¾ Google Books API è¼‰å…¥
                if (!product && productId && productId !== 'book001') {
                    console.log('å˜—è©¦å¾ Google Books API è¼‰å…¥...');
                    try {
                        product = await window.googleBooksAPI.getBookById(productId);
                        if (product && product.title) {
                            loadMethod = 'Google Books API';
                            console.log('âœ… å¾ Google Books API è¼‰å…¥æˆåŠŸ:', product.title);
                        }
                    } catch (error) {
                        console.warn('Google Books API è¼‰å…¥å¤±æ•—:', error.message);
                    }
                }

                // æ–¹æ³•3: å¾æ¨è–¦æ›¸ç±ä¸­å°‹æ‰¾
                if (!product && window.recommendedBooks && window.recommendedBooks.length > 0) {
                    console.log('å˜—è©¦å¾æ¨è–¦æ›¸ç±è¼‰å…¥...');
                    if (productId === 'book001' || !productId) {
                        product = window.recommendedBooks[0];
                    } else {
                        product = window.recommendedBooks.find(book => book.id === productId);
                    }
                    
                    if (product) {
                        loadMethod = 'æ¨è–¦æ›¸ç±';
                        console.log('âœ… å¾æ¨è–¦æ›¸ç±è¼‰å…¥:', product.title);
                    }
                }

                // æ–¹æ³•4: é‡æ–°æœå°‹è¼‰å…¥
                if (!product && productId) {
                    console.log('å˜—è©¦é‡æ–°æœå°‹è¼‰å…¥...');
                    try {
                        const searchQuery = getSearchQueryFromId(productId);
                        console.log('æœå°‹æŸ¥è©¢:', searchQuery);
                        const searchResults = await window.googleBooksAPI.searchBooks(searchQuery, 5);
                        
                        if (searchResults.length > 0) {
                            product = searchResults[0];
                            loadMethod = 'é‡æ–°æœå°‹';
                            console.log('âœ… é‡æ–°æœå°‹è¼‰å…¥æˆåŠŸ:', product.title);
                        }
                    } catch (error) {
                        console.warn('é‡æ–°æœå°‹å¤±æ•—:', error.message);
                    }
                }

                // æ–¹æ³•5: ä½¿ç”¨é è¨­è³‡æ–™
                if (!product) {
                    console.log('ä½¿ç”¨é è¨­å•†å“è³‡æ–™');
                    product = getDefaultProduct();
                    loadMethod = 'é è¨­è³‡æ–™';
                }

                // æ›´æ–°å•†å“é¡¯ç¤º
                console.log(`è¼‰å…¥æ–¹æ³•: ${loadMethod}`);
                updateProductDisplay(product);
                updateBreadcrumb(product);
                
                // ç¢ºä¿ç§»é™¤è¼‰å…¥ç‹€æ…‹
                showLoadingState(false);
                console.log('å•†å“è³‡æ–™è¼‰å…¥å®Œæˆ');
                
            } catch (error) {
                console.error('è¼‰å…¥å•†å“è³‡æ–™æ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ä¹Ÿè¦ç§»é™¤è¼‰å…¥ç‹€æ…‹
                showLoadingState(false);
                
                // é¡¯ç¤ºéŒ¯èª¤ä¸¦ä½¿ç”¨é è¨­è³‡æ–™
                showNotification('è¼‰å…¥å•†å“è³‡æ–™å¤±æ•—ï¼Œé¡¯ç¤ºé è¨­è³‡æ–™', 'warning');
                updateProductDisplay(getDefaultProduct());
                updateBreadcrumb(getDefaultProduct());
            }
        }

        // ç²å–é è¨­å•†å“è³‡æ–™
        function getDefaultProduct() {
            return {
                id: 'default-book',
                title: 'æš¢éŠ·ç¶“å…¸æ–‡å­¸ä½œå“',
                subtitle: 'Classic Literature Collection',
                author: 'çŸ¥åä½œå®¶',
                originalAuthor: 'Famous Author',
                translator: '',
                publisher: 'ç¶“å…¸å‡ºç‰ˆç¤¾',
                publishDate: '2024/01/01',
                language: 'ç¹é«”ä¸­æ–‡',
                originalPrice: 350,
                currentPrice: 280,
                discountRate: '8æŠ˜',
                discountNote: 'é™æ™‚å„ªæƒ ä¸­',
                stock: 20,
                isbn: '978-986-123-456-7',
                series: 'ç¶“å…¸ç³»åˆ—',
                specs: 'å¹³è£ / 320é  / 14.8 x 21 cm',
                origin: 'å°ç£',
                categories: ['æ–‡å­¸å°èªª', 'ç¶“å…¸æ–‡å­¸'],
                otherCategories: 'æ–‡å­¸å°èªª > ç¶“å…¸æ–‡å­¸',
                rating: 4.5,
                reviewCount: 128,
                imageUrl: 'https://via.placeholder.com/300x400/4CAF50/ffffff?text=ç¶“å…¸æ–‡å­¸',
                description: 'é€™æ˜¯ä¸€æœ¬ç²¾å½©çš„ç¶“å…¸æ–‡å­¸ä½œå“ï¼Œæ·±å—è®€è€…å–œæ„›ã€‚æœ¬æ›¸å…§å®¹è±å¯Œï¼Œæ–‡å­—å„ªç¾ï¼Œæ˜¯å€¼å¾—æ”¶è—çš„å¥½æ›¸ã€‚',
                authorIntroduction: 'ä½œè€…æ˜¯ä¸€ä½äº«è­½åœ‹éš›çš„çŸ¥åä½œå®¶ï¼Œå…¶ä½œå“å»£å—å¥½è©•ã€‚',
                previewLink: '',
                source: 'default'
            };
        }

        // æ”¹é€²çš„éŒ¯èª¤è™•ç†ç‰ˆæœ¬ - æ›´æ–°å•†å“é¡¯ç¤º
        function updateProductDisplay(product) {
            try {
                console.log('é–‹å§‹æ›´æ–°å•†å“é¡¯ç¤º:', product.title);
                
                // åŸºæœ¬è³‡æ–™é©—è­‰
                if (!product || typeof product !== 'object' || !product.title) {
                    console.error('ç„¡æ•ˆçš„å•†å“è³‡æ–™:', product);
                    product = getDefaultProduct();
                }
                
                // ä¿å­˜ç•¶å‰å•†å“
                updateCurrentProduct(product);
                
                // æ›´æ–°é é¢æ¨™é¡Œå’ŒåŸºæœ¬è³‡è¨Š
                document.getElementById('pageTitle').textContent = product.title + ' - æ›¸å®¢ä¾†ç·šä¸Šæ›¸åº—';
                document.getElementById('productTitle').textContent = product.title;
                document.getElementById('productSubtitle').textContent = product.subtitle || '';
                
                // æ›´æ–°ä½œè€…è³‡è¨Š - æ·»åŠ éŒ¯èª¤æª¢æŸ¥
                const authorElement = document.getElementById('productAuthor');
                if (authorElement) {
                    authorElement.innerHTML = `<a href="#">${product.author}</a>`;
                }
                
                // å®‰å…¨æ›´æ–°å„å€‹æ¬„ä½
                safeUpdateElement('originalAuthor', product.originalAuthor || product.author || '');
                safeUpdateElement('translator', product.translator || '');
                safeUpdateElement('publisher', product.publisher || '');
                safeUpdateElement('publishDate', product.publishDate || '');
                safeUpdateElement('language', product.language || 'ç¹é«”ä¸­æ–‡');
                
                // æ›´æ–°åƒ¹æ ¼è³‡è¨Š
                updatePriceInfo(product);
                
                // æ›´æ–°åº«å­˜è³‡è¨Š
                safeUpdateElement('stockStatus', `åº«å­˜ > ${product.stock || 10}`);
                
                // æ›´æ–°è©³ç´°è³‡æ–™
                updateDetailInfo(product);
                
                // æ›´æ–°è©•åˆ†è³‡è¨Š
                updateRatingInfo(product);
                
                // æ›´æ–°å•†å“åœ–ç‰‡
                updateProductImage(product);
                
                // æ›´æ–°å…§å®¹ç°¡ä»‹
                updateBookDescription(product);
                
                // æ›´æ–°ä½œè€…ä»‹ç´¹
                updateAuthorIntroduction(product);
                
                // æ·»åŠ é è¦½æŒ‰éˆ•
                addPreviewButton(product);
                
                console.log('âœ… å•†å“é¡¯ç¤ºæ›´æ–°å®Œæˆ');
                
            } catch (error) {
                console.error('æ›´æ–°å•†å“é¡¯ç¤ºæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                showNotification('å•†å“è³‡æ–™é¡¯ç¤ºç•°å¸¸', 'warning');
            }
        }

        // å®‰å…¨æ›´æ–°å…ƒç´ å…§å®¹
        function safeUpdateElement(elementId, content) {
            try {
                const element = document.getElementById(elementId);
                if (element) {
                    element.textContent = content;
                }
            } catch (error) {
                console.warn(`æ›´æ–°å…ƒç´  ${elementId} å¤±æ•—:`, error);
            }
        }

        // æ›´æ–°åƒ¹æ ¼è³‡è¨Š
        function updatePriceInfo(product) {
            try {
                let currentPriceText = '$299';
                let originalPriceText = '';
                
                if (product.currentPrice) {
                    if (typeof product.currentPrice === 'number') {
                        currentPriceText = `$${product.currentPrice}`;
                    } else {
                        currentPriceText = product.currentPrice.toString();
                        if (!currentPriceText.includes('$')) {
                            currentPriceText = '$' + currentPriceText;
                        }
                    }
                }
                
                if (product.originalPrice && product.originalPrice !== product.currentPrice) {
                    if (typeof product.originalPrice === 'number') {
                        originalPriceText = `å®šåƒ¹ï¼š$${product.originalPrice}`;
                    } else {
                        originalPriceText = `å®šåƒ¹ï¼š${product.originalPrice}`;
                    }
                }
                
                safeUpdateElement('currentPrice', currentPriceText);
                safeUpdateElement('originalPrice', originalPriceText);
                safeUpdateElement('priceNote', product.note || product.discountNote || 'å„ªæƒ ä¸­');
                
            } catch (error) {
                console.warn('æ›´æ–°åƒ¹æ ¼è³‡è¨Šå¤±æ•—:', error);
            }
        }

        // æ›´æ–°è©³ç´°è³‡æ–™
        function updateDetailInfo(product) {
            try {
                safeUpdateElement('isbn', product.isbn || 'è«‹åƒè€ƒå‡ºç‰ˆç¤¾è³‡è¨Š');
                safeUpdateElement('series', product.series || 'Google Books');
                safeUpdateElement('specs', product.specs || 
                    (product.pageCount ? `å¹³è£ / ${product.pageCount}é ` : 'è¦æ ¼è³‡è¨Šè«‹åƒè€ƒå‡ºç‰ˆç¤¾'));
                safeUpdateElement('origin', product.origin || 'å°ç£');
                
                // è™•ç†åˆ†é¡è³‡è¨Š
                let categoriesText = 'æ–‡å­¸å°èªª';
                if (product.categories) {
                    if (Array.isArray(product.categories)) {
                        categoriesText = product.categories.join(' > ');
                    } else {
                        categoriesText = product.categories.toString();
                    }
                }
                
                safeUpdateElement('categories', categoriesText);
                safeUpdateElement('otherCategories', product.otherCategories || categoriesText);
                
            } catch (error) {
                console.warn('æ›´æ–°è©³ç´°è³‡æ–™å¤±æ•—:', error);
            }
        }

        // æ›´æ–°è©•åˆ†è³‡è¨Š
        function updateRatingInfo(product) {
            try {
                const rating = product.rating || 4.5;
                const reviewCount = product.reviewCount || 10;
                
                safeUpdateElement('averageRating', rating);
                safeUpdateElement('totalReviews', `${reviewCount}äººè©•åˆ†`);
                safeUpdateElement('totalRatings', `${reviewCount}å‰‡æ›¸è©•`);
                
                // æ›´æ–°æ˜Ÿç´šé¡¯ç¤º
                const numRating = parseFloat(rating);
                const fullStars = Math.floor(numRating);
                const hasHalfStar = numRating % 1 >= 0.5;
                let stars = 'â˜…'.repeat(fullStars);
                if (hasHalfStar) stars += 'â˜†';
                stars += 'â˜†'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
                
                safeUpdateElement('ratingStars', stars);
                
            } catch (error) {
                console.warn('æ›´æ–°è©•åˆ†è³‡è¨Šå¤±æ•—:', error);
            }
        }

        // æ”¹é€²çš„è¼‰å…¥ç‹€æ…‹ç®¡ç†
        function showLoadingState(isLoading) {
            try {
                const productMain = document.querySelector('.product-main');
                const contentSections = document.querySelector('.content-sections');
                
                if (isLoading) {
                    console.log('é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹');
                    if (productMain) {
                        productMain.style.opacity = '0.5';
                        productMain.style.pointerEvents = 'none';
                    }
                    if (contentSections) {
                        contentSections.style.opacity = '0.5';
                    }
                    addLoadingIndicator();
                } else {
                    console.log('éš±è—è¼‰å…¥ç‹€æ…‹');
                    if (productMain) {
                        productMain.style.opacity = '1';
                        productMain.style.pointerEvents = 'auto';
                    }
                    if (contentSections) {
                        contentSections.style.opacity = '1';
                    }
                    removeLoadingIndicator();
                }
            } catch (error) {
                console.error('ç®¡ç†è¼‰å…¥ç‹€æ…‹å¤±æ•—:', error);
                // ç¢ºä¿ç§»é™¤è¼‰å…¥æŒ‡ç¤ºå™¨
                removeLoadingIndicator();
            }
        }

        // æ”¹é€²çš„å¾ sessionStorage ç²å–æœå°‹çµæœ
        function getSearchResultsFromSession() {
            try {
                const results = sessionStorage.getItem('lastSearchResults');
                if (results) {
                    const parsed = JSON.parse(results);
                    if (Array.isArray(parsed) && parsed.length > 0) {
                        console.log('å¾ sessionStorage è®€å–åˆ°æœå°‹çµæœ:', parsed.length, 'æœ¬æ›¸');
                        return parsed;
                    }
                }
                console.log('sessionStorage ä¸­æ²’æœ‰æœ‰æ•ˆçš„æœå°‹çµæœ');
                return null;
            } catch (error) {
                console.error('è®€å–æœå°‹çµæœå¤±æ•—:', error);
                return null;
            }
        }

        // æ”¹é€²çš„æ ¹æ“š ID ç”Ÿæˆæœå°‹æŸ¥è©¢
        function getSearchQueryFromId(productId) {
            if (!productId) return 'æš¢éŠ·æ›¸';
            
            const id = productId.toLowerCase();
            
            // æ ¹æ“šå¸¸è¦‹çš„ Google Books ID æ¨¡å¼é€²è¡Œæœå°‹
            if (id.includes('harry') || id.includes('potter')) {
                return 'å“ˆåˆ©æ³¢ç‰¹';
            } else if (id.includes('three') || id.includes('body')) {
                return 'ä¸‰é«”';
            } else if (id.includes('murakami')) {
                return 'æ‘ä¸Šæ˜¥æ¨¹';
            } else if (id.includes('psychology')) {
                return 'å¿ƒç†å­¸';
            } else if (id.includes('business')) {
                return 'å•†æ¥­ç†è²¡';
            } else if (id.includes('fiction')) {
                return 'æ–‡å­¸å°èªª';
            } else {
                // å˜—è©¦å¾ ID ä¸­æå–æœ‰ç”¨çš„æœå°‹è©
                return 'ç¶“å…¸æ–‡å­¸';
            }
        }

        // æ”¹é€²çš„åˆå§‹åŒ–é é¢å‡½æ•¸
        function initializePage() {
            console.log('ğŸš€ åˆå§‹åŒ–å•†å“è©³æƒ…é é¢');
            
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const productId = urlParams.get('id');
                
                console.log('URL åƒæ•¸ productId:', productId);
                
                // ç«‹å³é–‹å§‹è¼‰å…¥å•†å“è³‡æ–™
                loadProductData(productId || 'book001');
                
                // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
                checkLoginStatus();
                updateCartDisplay();
                loadReviews();
                
                // å»¶é²æ·»åŠ è¿”å›æŒ‰éˆ•
                setTimeout(addBackButton, 1000);
                
                console.log('âœ… é é¢åˆå§‹åŒ–å®Œæˆ');
                
            } catch (error) {
                console.error('é é¢åˆå§‹åŒ–å¤±æ•—:', error);
                
                // å³ä½¿åˆå§‹åŒ–å¤±æ•—ï¼Œä¹Ÿè¦ç¢ºä¿é¡¯ç¤ºé è¨­å…§å®¹
                showLoadingState(false);
                updateProductDisplay(getDefaultProduct());
                showNotification('é é¢è¼‰å…¥ç•°å¸¸ï¼Œé¡¯ç¤ºé è¨­å…§å®¹', 'warning');
            }
        }

        // æ›´æ–°å•†å“é¡¯ç¤º - ä¿®æ­£ç‰ˆæœ¬
        function updateProductDisplay(product) {
            try {
                console.log('æ›´æ–°å•†å“é¡¯ç¤º:', product.title);
                
                // ä¿å­˜ç•¶å‰å•†å“
                updateCurrentProduct(product);
                
                // æ›´æ–°é é¢æ¨™é¡Œå’ŒåŸºæœ¬è³‡è¨Š
                document.getElementById('pageTitle').textContent = product.title + ' - æ›¸å®¢ä¾†ç·šä¸Šæ›¸åº—';
                document.getElementById('productTitle').textContent = product.title;
                document.getElementById('productSubtitle').textContent = product.subtitle || '';
                
                // æ›´æ–°ä½œè€…è³‡è¨Š
                document.getElementById('productAuthor').innerHTML = `<a href="#">${product.author}</a> <a href="#" style="margin-left: 10px;">è¿½è¹¤ä½œè€…</a>`;
                document.getElementById('originalAuthor').textContent = product.originalAuthor || product.author || '';
                document.getElementById('translator').textContent = product.translator || '';
                document.getElementById('publisher').textContent = product.publisher || '';
                document.getElementById('publishDate').textContent = product.publishDate || '';
                document.getElementById('language').textContent = product.language || 'ç¹é«”ä¸­æ–‡';
                
                // æ›´æ–°åƒ¹æ ¼ - è™•ç†ä¸åŒçš„åƒ¹æ ¼æ ¼å¼
                let currentPriceText = '';
                let originalPriceText = '';
                
                if (product.currentPrice) {
                    if (typeof product.currentPrice === 'number') {
                        currentPriceText = `$${product.currentPrice}`;
                    } else {
                        currentPriceText = product.currentPrice.toString();
                    }
                    
                    if (product.discountRate) {
                        currentPriceText = `${product.discountRate} ${currentPriceText}`;
                    }
                }
                
                if (product.originalPrice) {
                    if (typeof product.originalPrice === 'number') {
                        originalPriceText = `å®šåƒ¹ï¼š$${product.originalPrice}`;
                    } else {
                        originalPriceText = `å®šåƒ¹ï¼š${product.originalPrice}`;
                    }
                }
                
                document.getElementById('currentPrice').textContent = currentPriceText || '$299';
                document.getElementById('originalPrice').textContent = originalPriceText;
                document.getElementById('priceNote').textContent = product.note || product.discountNote || 'é™æ™‚å„ªæƒ ä¸­';
                
                // æ›´æ–°åº«å­˜
                document.getElementById('stockStatus').textContent = `åº«å­˜ > ${product.stock || 10}`;
                
                // æ›´æ–°è©³ç´°è³‡æ–™
                document.getElementById('isbn').textContent = product.isbn || 'è«‹åƒè€ƒå‡ºç‰ˆç¤¾è³‡è¨Š';
                document.getElementById('series').textContent = product.series || 'Google Books';
                document.getElementById('specs').textContent = product.specs || 
                    (product.pageCount ? `å¹³è£ / ${product.pageCount}é ` : 'è¦æ ¼è³‡è¨Šè«‹åƒè€ƒå‡ºç‰ˆç¤¾');
                document.getElementById('origin').textContent = product.origin || 'å°ç£';
                
                // æ›´æ–°åˆ†é¡ - è™•ç†é™£åˆ—æˆ–å­—ä¸²æ ¼å¼
                let categoriesText = '';
                let otherCategoriesText = '';
                
                if (product.categories) {
                    if (Array.isArray(product.categories)) {
                        categoriesText = product.categories.join(' > ');
                        otherCategoriesText = product.categories.join(' > ');
                    } else {
                        categoriesText = product.categories.toString();
                        otherCategoriesText = product.categories.toString();
                    }
                } else {
                    categoriesText = 'æ–‡å­¸å°èªª';
                    otherCategoriesText = 'æ–‡å­¸å°èªª';
                }
                
                document.getElementById('categories').textContent = categoriesText;
                document.getElementById('otherCategories').textContent = product.otherCategories || otherCategoriesText;
                
                // æ›´æ–°è©•åˆ†
                const rating = product.rating || 5;
                const reviewCount = product.reviewCount || 5;
                
                document.getElementById('averageRating').textContent = rating;
                document.getElementById('totalReviews').textContent = `${reviewCount}äººè©•åˆ†`;
                document.getElementById('totalRatings').textContent = `${reviewCount}å‰‡æ›¸è©•`;
                
                // æ›´æ–°æ˜Ÿç´šé¡¯ç¤º
                const numRating = parseFloat(rating);
                const fullStars = Math.floor(numRating);
                const hasHalfStar = numRating % 1 >= 0.5;
                let stars = 'â˜…'.repeat(fullStars);
                if (hasHalfStar) stars += 'â˜†';
                stars += 'â˜†'.repeat(5 - fullStars - (hasHalfStar ? 1 : 0));
                document.getElementById('ratingStars').textContent = stars;
                
                // æ›´æ–°å•†å“åœ–ç‰‡
                updateProductImage(product);
                
                // æ›´æ–°å…§å®¹ç°¡ä»‹
                updateBookDescription(product);
                
                // æ›´æ–°ä½œè€…ä»‹ç´¹
                updateAuthorIntroduction(product);
                
                // æ·»åŠ é è¦½æŒ‰éˆ•ï¼ˆå¦‚æœæœ‰é è¦½é€£çµï¼‰
                addPreviewButton(product);
                
                console.log('å•†å“é¡¯ç¤ºæ›´æ–°å®Œæˆ');
                
            } catch (error) {
                console.error('æ›´æ–°å•†å“é¡¯ç¤ºå¤±æ•—:', error);
                showNotification('å•†å“è³‡æ–™é¡¯ç¤ºç•°å¸¸', 'warning');
            }
        }

        // æ›´æ–°å•†å“åœ–ç‰‡
        function updateProductImage(product) {
            const productImage = document.getElementById('productImage');
            
            if (product.imageUrl && product.imageUrl !== 'https://via.placeholder.com/300x400/f0f0f0/999999?text=æ›¸ç±å°é¢') {
                productImage.innerHTML = `
                    <img src="${product.imageUrl}" 
                         alt="${product.title}" 
                         style="width: 100%; height: 100%; object-fit: cover;" 
                         onerror="this.style.display='none'; this.parentElement.innerHTML='<div style=&quot;display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 14px;&quot;>å•†å“åœ–ç‰‡</div>';">
                `;
            } else {
                productImage.innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #999; font-size: 14px;">å•†å“åœ–ç‰‡</div>';
            }
        }

        // æ›´æ–°æ›¸ç±ç°¡ä»‹
        function updateBookDescription(product) {
            const description = document.getElementById('bookDescription');
            
            if (product.description && product.description.trim()) {
                // å°‡ç°¡ä»‹åˆ†æ®µé¡¯ç¤ºï¼Œè™•ç†æ›è¡Œç¬¦è™Ÿ
                const paragraphs = product.description
                    .split(/\n+/)
                    .filter(p => p.trim())
                    .map(p => p.trim());
                
                if (paragraphs.length > 0) {
                    description.innerHTML = paragraphs.map(p => `<p>${p}</p>`).join('');
                } else {
                    description.innerHTML = `<p>${product.description}</p>`;
                }
            } else {
                // ä½¿ç”¨é è¨­ç°¡ä»‹
                description.innerHTML = `
                    <p>é€™æ˜¯ä¸€æœ¬ç²¾å½©çš„æ›¸ç±ï¼Œç”± ${product.author} æ‰€è‘—ã€‚</p>
                    <p>æœ¬æ›¸ç”± ${product.publisher || 'çŸ¥åå‡ºç‰ˆç¤¾'} å‡ºç‰ˆï¼Œå€¼å¾—æ‚¨ç´°ç´°å“å‘³ã€‚</p>
                    <p>æ­¡è¿é»æ“Šã€Œç·šä¸Šé è¦½ã€æŒ‰éˆ•äº†è§£æ›´å¤šå…§å®¹ã€‚</p>
                `;
            }
        }

        // æ›´æ–°ä½œè€…ä»‹ç´¹
        function updateAuthorIntroduction(product) {
            const authorName = document.getElementById('authorName');
            const authorIntroduction = document.getElementById('authorIntroduction');
            
            authorName.textContent = product.author || 'ä½œè€…';
            
            if (product.authorIntroduction) {
                authorIntroduction.textContent = product.authorIntroduction;
            } else {
                authorIntroduction.innerHTML = `
                    <p>${product.author} æ˜¯ä¸€ä½å„ªç§€çš„ä½œå®¶ï¼Œå…¶ä½œå“æ·±å—è®€è€…å–œæ„›ã€‚</p>
                    <p>æ›´å¤šä½œè€…è³‡è¨Šè«‹åƒè€ƒå‡ºç‰ˆç¤¾å®˜æ–¹ä»‹ç´¹ã€‚</p>
                `;
            }
        }

        // æ·»åŠ é è¦½æŒ‰éˆ•
        function addPreviewButton(product) {
            if (product.previewLink) {
                const purchaseSection = document.querySelector('.purchase-section .purchase-buttons');
                
                // æª¢æŸ¥æ˜¯å¦å·²ç¶“æœ‰é è¦½æŒ‰éˆ•
                const existingPreviewBtn = purchaseSection.querySelector('a[href*="books.google"], a[href*="preview"]');
                if (existingPreviewBtn) {
                    existingPreviewBtn.remove();
                }
                
                const previewBtn = document.createElement('a');
                previewBtn.href = product.previewLink;
                previewBtn.target = '_blank';
                previewBtn.className = 'btn btn-outline';
                previewBtn.textContent = 'ğŸ“– ç·šä¸Šé è¦½';
                previewBtn.style.marginTop = '10px';
                
                purchaseSection.appendChild(previewBtn);
            }
        }

        // å¾ sessionStorage ç²å–æœå°‹çµæœ
        function getSearchResultsFromSession() {
            try {
                const results = sessionStorage.getItem('lastSearchResults');
                if (results) {
                    const parsed = JSON.parse(results);
                    console.log('å¾ sessionStorage è®€å–åˆ°æœå°‹çµæœ:', parsed.length, 'æœ¬æ›¸');
                    return parsed;
                }
                return null;
            } catch (error) {
                console.error('ç„¡æ³•è®€å–æœå°‹çµæœ:', error);
                return null;
            }
        }

        // æ ¹æ“š ID ç”Ÿæˆæœå°‹æŸ¥è©¢
        function getSearchQueryFromId(productId) {
            if (!productId) return 'æš¢éŠ·æ›¸';
            
            const id = productId.toLowerCase();
            
            if (id.includes('harry') || id.includes('potter')) {
                return 'å“ˆåˆ©æ³¢ç‰¹';
            } else if (id.includes('three') || id.includes('body')) {
                return 'ä¸‰é«”';
            } else if (id.includes('village') || id.includes('murakami')) {
                return 'æ‘ä¸Šæ˜¥æ¨¹';
            } else if (id.includes('psychology')) {
                return 'å¿ƒç†å­¸';
            } else if (id.includes('business')) {
                return 'å•†æ¥­ç†è²¡';
            } else if (id.includes('fiction')) {
                return 'æ–‡å­¸å°èªª';
            } else {
                return 'æš¢éŠ·æ›¸';
            }
        }

        // æ›´æ–°éºµåŒ…å±‘å°èˆª
        function updateBreadcrumb(product) {
            const breadcrumbPath = document.getElementById('breadcrumbPath');
            if (breadcrumbPath) {
                let categories = ['ä¸­æ–‡æ›¸', 'æ–‡å­¸å°èªª'];
                
                if (product.categories) {
                    if (Array.isArray(product.categories)) {
                        categories = product.categories.slice(0, 3);
                    } else if (typeof product.categories === 'string') {
                        categories = product.categories.split('>').map(c => c.trim()).slice(0, 3);
                    }
                }
                
                const breadcrumbHTML = `
                    <a href="index.html">æ›¸å®¢ä¾†</a> > 
                    ${categories.map(cat => `<a href="#">${cat}</a>`).join(' > ')} > 
                    <span>å•†å“ä»‹ç´¹</span>
                `;
                
                breadcrumbPath.innerHTML = breadcrumbHTML;
            }
        }

        // å„²å­˜ç›®å‰å•†å“åˆ°å…¨åŸŸè®Šæ•¸
        function updateCurrentProduct(product) {
            if (!product || typeof product !== 'object') {
                console.error('ç„¡æ•ˆçš„å•†å“è³‡æ–™:', product);
                return;
            }
            
            currentProduct = {
                ...currentProduct,
                ...product,
                title: product.title || currentProduct.title,
                author: product.author || currentProduct.author,
                currentPrice: product.currentPrice || currentProduct.currentPrice,
                categories: product.categories || currentProduct.categories
            };
            
            try {
                sessionStorage.setItem('currentProduct', JSON.stringify(currentProduct));
                console.log('å•†å“è³‡æ–™å·²ä¿å­˜åˆ° sessionStorage');
            } catch (error) {
                console.error('ç„¡æ³•ä¿å­˜å•†å“è³‡æ–™:', error);
            }
        }

        // é¡¯ç¤ºè¼‰å…¥ç‹€æ…‹
        function showLoadingState(isLoading) {
            const productMain = document.querySelector('.product-main');
            const contentSections = document.querySelector('.content-sections');
            
            if (isLoading) {
                if (productMain) {
                    productMain.style.opacity = '0.5';
                    productMain.style.pointerEvents = 'none';
                }
                if (contentSections) {
                    contentSections.style.opacity = '0.5';
                }
                addLoadingIndicator();
            } else {
                if (productMain) {
                    productMain.style.opacity = '1';
                    productMain.style.pointerEvents = 'auto';
                }
                if (contentSections) {
                    contentSections.style.opacity = '1';
                }
                removeLoadingIndicator();
            }
        }

        // æ·»åŠ è¼‰å…¥æŒ‡ç¤ºå™¨
        function addLoadingIndicator() {
            const existingIndicator = document.getElementById('productLoadingIndicator');
            if (existingIndicator) return;
            
            const indicator = document.createElement('div');
            indicator.id = 'productLoadingIndicator';
            indicator.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background-color: rgba(255, 255, 255, 0.95);
                padding: 30px;
                border-radius: 12px;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                z-index: 1000;
                text-align: center;
            `;
            
            indicator.innerHTML = `
                <div style="width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #4CAF50; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px;"></div>
                <p style="color: #666; font-size: 16px; margin: 0;">æ­£åœ¨è¼‰å…¥æ›¸ç±è³‡æ–™...</p>
            `;
            
            // æ·»åŠ æ—‹è½‰å‹•ç•«
            const style = document.createElement('style');
            style.textContent = `
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            `;
            document.head.appendChild(style);
            
            document.body.appendChild(indicator);
        }

        // ç§»é™¤è¼‰å…¥æŒ‡ç¤ºå™¨
        function removeLoadingIndicator() {
            const indicator = document.getElementById('productLoadingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        // æ·»åŠ è¿”å›æœå°‹çµæœåŠŸèƒ½
        function goBackToSearch() {
            const referrer = document.referrer;
            if (referrer && referrer.includes('search-results.html')) {
                window.history.back();
            } else {
                window.location.href = 'index.html';
            }
        }

        // æ·»åŠ è¿”å›æŒ‰éˆ•
        function addBackButton() {
            const breadcrumb = document.querySelector('.breadcrumb .container');
            if (breadcrumb && document.referrer.includes('search-results.html')) {
                if (breadcrumb.querySelector('.back-to-search-btn')) return;
                
                const backBtn = document.createElement('button');
                backBtn.className = 'back-to-search-btn';
                backBtn.textContent = 'â† è¿”å›æœå°‹çµæœ';
                backBtn.style.cssText = `
                    background-color: #4CAF50;
                    color: white;
                    border: none;
                    padding: 8px 15px;
                    border-radius: 4px;
                    cursor: pointer;
                    font-size: 13px;
                    margin-left: 15px;
                    transition: background-color 0.3s;
                `;
                backBtn.onmouseover = () => backBtn.style.backgroundColor = '#45a049';
                backBtn.onmouseout = () => backBtn.style.backgroundColor = '#4CAF50';
                backBtn.onclick = goBackToSearch;
                
                breadcrumb.appendChild(backBtn);
            }
        }

        // æœå°‹åŠŸèƒ½
        function performSearch() {
            const category = document.getElementById('searchCategory').value;
            const keyword = document.getElementById('searchInput').value.trim();
            
            if (keyword === '') {
                alert('è«‹è¼¸å…¥æœå°‹é—œéµå­—');
                return;
            }
            
            // è·³è½‰åˆ°æœå°‹çµæœé é¢
            const searchUrl = `search-results.html?q=${encodeURIComponent(keyword)}&category=${encodeURIComponent(category)}`;
            window.location.href = searchUrl;
        }

        // è¼‰å…¥è©•åƒ¹
        function loadReviews() {
            const reviewsList = document.getElementById('reviewsList');
            reviewsList.innerHTML = reviews.map(review => `
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-avatar">${review.reviewer.charAt(0)}</div>
                        <div class="reviewer-info">
                            <div class="reviewer-name">${review.reviewer}</div>
                            <div class="review-date">${review.level} ${review.date}</div>
                        </div>
                        <div class="review-rating">${'â˜…'.repeat(review.rating)}</div>
                    </div>
                    <div class="review-content">
                        ${review.title ? `<div class="review-title">${review.title}</div>` : ''}
                        <p>${review.content}</p>
                    </div>
                    <div class="review-helpful">
                        <button class="helpful-btn" onclick="markHelpful(${review.id})">
                            ğŸ‘ æœ‰å¹«åŠ©(${review.helpful})
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // æ¨™ç±¤åˆ‡æ›
        function showContentTab(tabName, element) {
            document.querySelectorAll('.content-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.content-panel').forEach(panel => {
                panel.classList.remove('active');
            });
            
            element.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // åŠ å…¥è³¼ç‰©è»Š
        function addToCart() {
            let cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            
            const existingItem = cartItems.find(item => item.id === currentProduct.id);
            
            if (existingItem) {
                existingItem.quantity += 1;
            } else {
                cartItems.push({
                    id: currentProduct.id,
                    title: currentProduct.title,
                    price: currentProduct.currentPrice,
                    originalPrice: currentProduct.originalPrice,
                    note: currentProduct.discountNote,
                    quantity: 1,
                    stock: 'æœ‰',
                    selected: true
                });
            }
            
            localStorage.setItem('cartItems', JSON.stringify(cartItems));
            updateCartDisplay();
            
            showNotification(`âœ… ã€Œ${currentProduct.title}ã€å·²åŠ å…¥è³¼ç‰©è»Šï¼`, 'success');
        }

        // ç«‹å³è³¼è²·
        function buyNow() {
            addToCart();
            setTimeout(() => {
                window.location.href = 'shopping.html';
            }, 500);
        }

        // åŠ å…¥é¡˜æœ›æ¸…å–®
        function addToWishlist() {
            showNotification(`ğŸ’ ã€Œ${currentProduct.title}ã€å·²åŠ å…¥ä¸‹æ¬¡å†è²·æ¸…å–®ï¼`, 'info');
        }

        // é¡¯ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background-color: ${type === 'success' ? '#4CAF50' : type === 'info' ? '#2196F3' : '#ff9800'};
                color: white;
                padding: 15px 20px;
                border-radius: 5px;
                z-index: 1000;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                max-width: 300px;
                font-size: 14px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // åˆ†äº«åŠŸèƒ½
        function shareToFacebook() {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(currentProduct.title);
            window.open(`https://www.facebook.com/sharer/sharer.php?u=${url}&quote=${title}`, '_blank');
        }

        function shareToLine() {
            const url = encodeURIComponent(window.location.href);
            const title = encodeURIComponent(currentProduct.title);
            window.open(`https://social-plugins.line.me/lineit/share?url=${url}&text=${title}`, '_blank');
        }

        function copyLink() {
            navigator.clipboard.writeText(window.location.href).then(() => {
                showNotification('ğŸ“‹ é€£çµå·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼', 'success');
            });
        }

        // è©•åƒ¹ç›¸é—œåŠŸèƒ½
        function writeReview() {
            showNotification('ğŸ“ è©•åƒ¹åŠŸèƒ½é–‹ç™¼ä¸­...', 'info');
        }

        function markHelpful(reviewId) {
            showNotification('ğŸ‘ æ„Ÿè¬æ‚¨çš„å›é¥‹ï¼', 'success');
        }

        // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
        function checkLoginStatus() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const userEmail = localStorage.getItem('userEmail');
            
            if (isLoggedIn === 'true' && userEmail) {
                document.getElementById('userInfo').textContent = `æ­¡è¿ï¼Œ${userEmail}`;
                document.getElementById('loginLogoutBtn').textContent = 'ç™»å‡º';
                document.getElementById('loginLogoutBtn').onclick = logout;
            }
        }

        // æ›´æ–°è³¼ç‰©è»Šæ•¸é‡é¡¯ç¤º
        function updateCartDisplay() {
            const cartItems = JSON.parse(localStorage.getItem('cartItems') || '[]');
            const cartCount = cartItems.reduce((total, item) => total + item.quantity, 0);
            document.getElementById('cartCount').textContent = cartCount;
        }

        // ç™»å‡ºåŠŸèƒ½
        function logout() {
            if (confirm('ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ')) {
                localStorage.removeItem('isLoggedIn');
                localStorage.removeItem('userEmail');
                localStorage.removeItem('loginTime');
                alert('å·²æˆåŠŸç™»å‡º');
                checkLoginStatus();
            }
        }

        // è™•ç†ç™»å…¥ç™»å‡º
        function handleLoginLogout() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn === 'true') {
                logout();
            } else {
                window.location.href = 'login.html';
            }
        }

        // å…¶ä»–å°èˆªåŠŸèƒ½
        function showOrders() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            if (isLoggedIn !== 'true') {
                window.location.href = 'login.html?redirect=ordersearch.html';
                return;
            }
            window.location.href = 'ordersearch.html';
        }

        function showNewReleases() {
            alert('æ–°æ›¸æ¨è–¦é é¢é–‹ç™¼ä¸­...');
        }

        function showBestsellers() {
            alert('æš¢éŠ·æ¦œé é¢é–‹ç™¼ä¸­...');
        }

        function showEbooks() {
            alert('é›»å­æ›¸åŸé é¢é–‹ç™¼ä¸­...');
        }

        function toggleLanguage() {
            alert('èªè¨€åˆ‡æ›åŠŸèƒ½é–‹ç™¼ä¸­...');
        }

        // åˆå§‹åŒ–é é¢
        function initializePage() {
            console.log('åˆå§‹åŒ–å•†å“è©³æƒ…é é¢');
            
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('id');
            
            console.log('URL åƒæ•¸ productId:', productId);
            
            loadProductData(productId || 'book001');
            
            checkLoginStatus();
            updateCartDisplay();
            loadReviews();
            
            setTimeout(addBackButton, 1500);
        }

        // æœå°‹æ¡† Enter éµæ”¯æ´
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });

        // é é¢è¼‰å…¥æ™‚åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
            console.log('å•†å“è©³æƒ…é é¢å·²è¼‰å…¥å®Œæˆ');
        });

        // å…¨åŸŸå‡½æ•¸
        window.showProductDetail = function(productId) {
            window.location.href = `product.html?id=${productId}`;
        };
    </script>
</body>
</html>